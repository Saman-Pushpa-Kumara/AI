<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXT GEN ULTRA TV</title>
    
    <!-- External Player Libraries -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15"></script>
    
    <!-- VideoJS -->
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <link href="https://unpkg.com/@videojs/themes@1/dist/city/index.css" rel="stylesheet" />
    
    <!-- FIREBASE LIBRARIES (Added instead of Supabase) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- SUPER NEXT GEN UI THEME --- */
        :root {
            --primary-bg: #000000; 
            --secondary-bg: #0f0f13;
            --accent-color: #E50914; 
            --accent-glow: rgba(229, 9, 20, 0.4);
            --text-primary: #ffffff;
            --text-secondary: #94969f;
            --glass-bg: rgba(20, 20, 25, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --card-gradient: linear-gradient(145deg, rgba(255,255,255,0.07) 0%, rgba(255,255,255,0.02) 100%);
            --nav-bg: rgba(15, 15, 20, 0.85);
            --card-radius: 16px;
            --font-main: 'Outfit', sans-serif;
            --live-red: #E50914;
            --live-glow: rgba(229, 9, 20, 0.6);
        }

        body.light-theme {
            --primary-bg: #eef2f5;
            --secondary-bg: #ffffff;
            --accent-color: #0066ff;
            --accent-glow: rgba(0, 102, 255, 0.2);
            --text-primary: #1a1a1d;
            --text-secondary: #5f6368;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(0, 0, 0, 0.06);
            --card-gradient: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
            --nav-bg: rgba(255, 255, 255, 0.9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--primary-bg);
            background-image: radial-gradient(circle at 10% 20%, rgba(229, 9, 20, 0.03) 0%, transparent 40%),
                              radial-gradient(circle at 90% 80%, rgba(229, 9, 20, 0.03) 0%, transparent 40%);
            color: var(--text-primary);
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 110px;
            transition: background 0.4s ease;
        }
        
        body.light-theme {
            background-image: radial-gradient(circle at 10% 20%, rgba(0, 102, 255, 0.03) 0%, transparent 40%),
                              radial-gradient(circle at 90% 80%, rgba(0, 102, 255, 0.03) 0%, transparent 40%);
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 var(--live-glow); } 70% { box-shadow: 0 0 0 8px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-3px); } 100% { transform: translateY(0px); } }

        /* --- Header --- */
        .header {
            position: fixed; top: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto;
            height: 75px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100;
            background: linear-gradient(to bottom, var(--primary-bg) 20%, transparent 100%);
        }
        
        .logo { font-size: 24px; font-weight: 800; color: var(--text-primary); letter-spacing: -0.5px; display: flex; align-items: center; }
        .logo span { color: var(--accent-color); text-shadow: 0 0 15px var(--accent-glow); margin-left: 2px; }
        
        .live-dot { 
            width: 8px; height: 8px; 
            background: #00ff00; 
            border-radius: 50%; margin-left: 8px; margin-top: 4px; 
            --live-glow: rgba(0, 255, 0, 0.6); 
            animation: pulse-glow 2s infinite; 
        }

        .search-box { 
            position: relative; width: 40px; height: 40px; 
            margin-left: auto; margin-right: 0; 
            border-radius: 50px; background: var(--glass-bg); 
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden; border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: flex-end;
        }
        .search-box:focus-within { width: 65%; background: var(--secondary-bg); border-color: var(--accent-color); box-shadow: 0 0 15px var(--accent-glow); }
        .search-input {
            width: 100%; height: 100%; padding: 0 15px 0 40px;
            background: transparent; border: none; color: var(--text-primary); 
            font-size: 14px; opacity: 0; transition: opacity 0.3s;
            position: absolute; left: 0;
        }
        .search-box:focus-within .search-input { opacity: 1; }
        .search-icon { 
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%); 
            color: var(--text-primary); font-size: 16px; pointer-events: none; transition: right 0.3s;
        }
        .search-box:focus-within .search-icon { right: auto; left: 15px; color: var(--accent-color); }

        /* --- Hero / Random Slider --- */
        .main-channel-poster {
            margin-top: 0; width: 100%; height: 380px; position: relative; overflow: hidden;
            border-radius: 0 0 30px 30px;
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }
        .poster-slider { display: flex; height: 100%; transition: transform 0.7s cubic-bezier(0.25, 1, 0.5, 1); }
        .poster-slide { min-width: 100%; height: 100%; position: relative; }
        .poster-slide img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.9); }
        .slide-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(to top, var(--primary-bg) 0%, rgba(0,0,0,0.6) 40%, transparent 80%);
            display: flex; flex-direction: column; justify-content: flex-end; padding: 40px 20px;
        }
        .slide-tag { 
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px);
            color: #fff; padding: 4px 10px; border-radius: 6px; 
            font-size: 10px; font-weight: 700; width: fit-content; margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.2); letter-spacing: 1px;
        }
        .slide-title { font-size: 28px; font-weight: 800; color: #fff; line-height: 1.1; margin-bottom: 5px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        
        /* --- Categories & Channels --- */
        .category-section { margin-top: 25px; animation: fadeIn 0.6s ease; }
        .category-header { display: flex; justify-content: space-between; align-items: flex-end; padding: 0 25px 15px; }
        .category-title { 
            font-size: 18px; font-weight: 700; color: var(--text-primary); 
            position: relative; padding-left: 0;
        }
        .category-title::after {
            content: ''; position: absolute; bottom: -4px; left: 0; width: 20px; height: 3px; 
            background: var(--accent-color); border-radius: 2px; box-shadow: 0 0 8px var(--accent-glow);
        }
        .see-all { font-size: 12px; font-weight: 600; color: var(--accent-color); text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: 0.2s; }
        .see-all:active { opacity: 0.6; }

        .channel-slider {
            display: flex; gap: 15px; overflow-x: auto; padding: 0 25px 20px;
            scroll-snap-type: x mandatory; scroll-behavior: smooth;
        }
        
        .channel-card {
            flex: 0 0 120px; height: 160px; position: relative;
            background: var(--card-gradient); 
            border-radius: var(--card-radius);
            overflow: hidden; scroll-snap-align: start; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid var(--glass-border);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .channel-card:hover { transform: translateY(-5px) scale(1.02); border-color: var(--accent-color); box-shadow: 0 10px 20px rgba(0,0,0,0.3), 0 0 15px var(--accent-glow); }
        .channel-image { width: 65px; height: 65px; object-fit: contain; margin-bottom: 12px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4)); transition: transform 0.3s; }
        .channel-card:hover .channel-image { transform: scale(1.1); }
        
        .channel-name { 
            font-size: 12px; text-align: center; color: var(--text-primary); 
            padding: 0 8px; font-weight: 600; line-height: 1.3;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; opacity: 0.9;
        }
        
        .card-live-badge {
            position: absolute; top: 10px; left: 10px;
            background: rgba(229, 9, 20, 0.2); color: #E50914;
            border: 1px solid rgba(229, 9, 20, 0.3);
            font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: 20px;
            z-index: 5; animation: blink 2s infinite; 
        }
        .favorite-icon { 
            position: absolute; top: 10px; right: 10px; 
            font-size: 16px; color: rgba(255,255,255,0.3); z-index: 5; 
            transition: 0.2s;
        }
        .favorite-icon:active { transform: scale(1.3); }
        .favorite-icon.is-favorite { color: #E50914; filter: drop-shadow(0 0 5px var(--live-red)); }
        
        /* --- Grid & Pages --- */
        .content-page { padding: 90px 20px 80px; display: none; min-height: 100vh; animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .page-title { font-size: 28px; font-weight: 800; margin-bottom: 25px; color: var(--text-primary); letter-spacing: -0.5px; }
        .page-title i { color: var(--accent-color); margin-right: 10px; }
        
        .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 15px; }
        .content-grid .channel-card { width: 100%; flex: unset; height: 150px; }

        /* --- Settings --- */
        .setting-item {
            background: var(--card-gradient); padding: 18px; border-radius: 18px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid var(--glass-border);
            transition: 0.2s;
        }
        .setting-item:active { transform: scale(0.98); background: rgba(255,255,255,0.08); }
        .setting-label { font-size: 15px; color: var(--text-primary); font-weight: 500; display: flex; align-items: center; }
        .setting-label i { margin-right: 12px; color: var(--accent-color); width: 20px; text-align: center; } 
        
        .toggle-switch { position: relative; width: 46px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.1); border-radius: 34px; transition: .4s; border: 1px solid var(--glass-border); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: #fff; border-radius: 50%; transition: .4s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--accent-color); border-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); background: #fff; }

        /* --- Bottom Nav (Floating Island) --- */
        .nav-bar {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 88%; max-width: 380px; height: 70px;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 35px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4); z-index: 1000;
            padding: 0 10px;
        }
        
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-secondary); text-decoration: none; width: 60px; height: 100%;
            transition: all 0.3s; position: relative;
        }
        .nav-item i { font-size: 20px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item span { font-size: 10px; font-weight: 600; opacity: 0.7; transition: 0.3s; }
        
        .nav-item.active { color: var(--accent-color); }
        .nav-item.active i { transform: translateY(-3px); text-shadow: 0 0 15px var(--accent-glow); }
        .nav-item.active span { opacity: 1; transform: translateY(-3px); }
        
        .nav-item.active::after {
            content: ''; position: absolute; bottom: 8px; width: 4px; height: 4px;
            background: var(--accent-color); border-radius: 50%; box-shadow: 0 0 5px var(--accent-glow);
        }

        /* --- Player UI --- */
        .video-player {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; display: none; flex-direction: column;
        }
        .video-wrapper { width: 100%; height: 35vh; position: relative; background: #000; flex-shrink: 0; transition: height 0.3s ease; box-shadow: 0 10px 50px rgba(0,0,0,0.5); }
        
        .plyr { width: 100%; height: 100%; --plyr-color-main: var(--accent-color); }
        
        .video-close {
            position: absolute; top: 20px; right: 20px; z-index: 2010;
            width: 40px; height: 40px; background: rgba(0,0,0,0.5); border-radius: 50%;
            color: #fff; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: 0.2s;
        }
        .video-close:active { transform: scale(0.9); background: var(--accent-color); color: #fff; }

        .player-details-panel { flex: 1; overflow-y: auto; background: var(--primary-bg); padding: 0; }
        .pd-header-area { 
            padding: 25px 20px; 
            background: linear-gradient(to bottom, var(--secondary-bg), var(--primary-bg)); 
            border-bottom: 1px solid var(--glass-border); 
        }
        .pd-title-row { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .pd-logo-img { 
            width: 60px; height: 60px; border-radius: 16px; background: #fff; 
            padding: 5px; object-fit: contain; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .pd-main-title { font-size: 22px; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
        .pd-sub-tag { 
            font-size: 11px; color: var(--accent-color); background: rgba(229, 9, 20, 0.1); 
            padding: 5px 12px; border-radius: 20px; border: 1px solid rgba(229, 9, 20, 0.2); 
            display: inline-block; margin-top: 5px;
        }
        
        .pd-actions-row { display: flex; gap: 12px; margin-bottom: 15px; }
        .action-btn { 
            flex: 1; padding: 12px; border-radius: 12px; border: none; font-size: 13px; font-weight: 600; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-fav { background: rgba(255,255,255,0.05); color: var(--text-primary); border: 1px solid var(--glass-border); }
        .btn-fav:active { transform: scale(0.98); }
        .btn-fav.active { background: rgba(229, 9, 20, 0.15); color: #E50914; border-color: rgba(229, 9, 20, 0.3); box-shadow: 0 0 10px rgba(229, 9, 20, 0.2); }
        .btn-share { background: var(--accent-color); color: #fff; border: none; box-shadow: 0 0 10px var(--accent-glow); }
        .btn-share:active { opacity: 0.8; }

        .pd-content-area { padding: 25px 20px; }
        .meta-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; font-size: 13px; }
        .meta-table td { padding: 12px 15px; background: rgba(255,255,255,0.03); border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border); }
        .meta-table td:first-child { border-left: 1px solid var(--glass-border); border-radius: 12px 0 0 12px; color: var(--text-secondary); width: 120px; font-weight: 500; }
        .meta-table td:last-child { border-right: 1px solid var(--glass-border); border-radius: 0 12px 12px 0; color: var(--text-primary); font-weight: 600; }

        .loader-container { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: #000; z-index: 5; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; box-shadow: 0 0 15px var(--accent-glow); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .fill-mode video { object-fit: cover !important; }

        /* --- Custom CSS Rotation Class --- */
        .force-landscape {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vh !important;
            height: 100vw !important;
            transform: rotate(90deg) !important;
            transform-origin: bottom left !important;
            margin-top: -100vw !important;
            z-index: 99999 !important;
            background: #000;
        }
        .force-landscape .video-wrapper {
            height: 100% !important; /* Video fills rotated container */
            width: 100% !important;
        }
        .force-landscape .player-details-panel {
            display: none !important; /* Hide details in rotated mode */
        }
        .force-landscape .video-close {
             top: 20px; right: 20px; /* Adjust close button position if needed */
        }


        /* --- Modals (Bottom Sheet Style) --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2200; 
            display: none; align-items: flex-end; justify-content: center; 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .custom-modal { 
            background: #15151a; width: 100%; max-width: 500px; 
            border-radius: 30px 30px 0 0; padding: 30px 25px 40px; 
            border-top: 1px solid rgba(255,255,255,0.1); 
            display: flex; flex-direction: column; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .modal-overlay.active .custom-modal { transform: translateY(0); }
        
        .custom-modal::before {
            content: ''; position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 10px;
        }

        .sort-list-container { overflow-y: auto; margin: 20px 0; max-height: 50vh; padding-right: 5px; }
        .sort-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.03); padding: 12px 15px; margin-bottom: 10px; 
            border-radius: 12px; border: 1px solid var(--glass-border);
        }
        .sort-controls { display: flex; gap: 8px; }
        .sort-btn { 
            background: rgba(255,255,255,0.05); border: none; color: var(--text-secondary); 
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; 
        }
        .sort-btn:active { background: var(--accent-color); color: #fff; }

        .modal-footer { margin-top: auto; display: flex; gap: 15px; }
        .modal-btn { flex: 1; padding: 14px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; }
        .btn-confirm { background: var(--accent-color); color: #fff; box-shadow: 0 0 15px var(--accent-glow); }
        .btn-cancel { background: transparent; border: 1px solid var(--glass-border); color: var(--text-secondary); }

        /* --- Profile Modal Styles --- */
        .profile-content-scroll { overflow-y: auto; text-align: left; padding-right: 5px; max-height: 60vh; }
        .privacy-title { font-size: 20px; color: var(--accent-color); font-weight: 800; margin-bottom: 15px; text-align: center; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; letter-spacing: 1px; }
        .privacy-text { font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6; }
        
        .disclaimer-box {
            background: rgba(229, 9, 20, 0.08); border: 1px solid rgba(229, 9, 20, 0.2);
            border-radius: 12px; padding: 15px; margin-bottom: 20px;
        }
        .disclaimer-title { color: #E50914; font-weight: 700; font-size: 12px; margin-bottom: 8px; display: block; letter-spacing: 0.5px; }
        .disclaimer-text { font-size: 11px; color: #ffa5ab; line-height: 1.5; text-align: justify; }

        .edu-note { font-size: 11px; color: var(--text-secondary); text-align: center; margin-bottom: 20px; font-style: italic; opacity: 0.7; }
        
        .contact-section { margin-top: 15px; border-top: 1px solid var(--glass-border); padding-top: 20px; }
        .contact-card {
            display: flex; align-items: center; gap: 15px;
            background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px;
            margin-bottom: 10px; text-decoration: none; border: 1px solid transparent;
            transition: 0.2s;
        }
        .contact-card:hover { border-color: var(--accent-color); background: rgba(229, 9, 20, 0.05); transform: translateX(5px); }
        .contact-icon { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .bg-email { background: linear-gradient(135deg, #EA4335, #c5221f); }
        .bg-whatsapp { background: linear-gradient(135deg, #25D366, #128c7e); }
        .contact-info div { font-size: 11px; color: var(--text-secondary); margin-bottom: 2px; }
        .contact-info span { font-size: 14px; color: var(--text-primary); font-weight: 600; }

        .about-footer { margin-top: 25px; text-align: center; }
        .about-name { font-size: 16px; font-weight: 700; color: var(--text-primary); letter-spacing: 0.5px; }
        .about-loc { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="header" id="main-header">
        <div class="logo">ULTRA<span>TV</span><div class="live-dot"></div></div>
        
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="search-input" placeholder="Search Channels..." onkeyup="searchContent()">
        </div>
    </div>

    <!-- Home Page -->
    <div id="home-page"> 
        <div class="main-channel-poster">
             <div class="poster-slider" id="poster-slider">
                 <!-- Generated by JS -->
             </div>
        </div>
        <div id="channel-categories-container" style="padding-bottom: 20px;"></div>
    </div>
    
    <!-- Other Pages -->
    <div id="all-channels-page" class="content-page">
        <h2 class="page-title">All Channels</h2>
        <div class="content-grid" id="all-channels-grid"></div>
    </div>

    <div id="favorites-page" class="content-page">
        <h2 class="page-title"><i class="fas fa-heart"></i> My Favorites</h2>
        <div class="content-grid" id="favorites-grid"></div>
    </div>

    <div id="setting-page" class="content-page">
        <h2 class="page-title"><i class="fas fa-cog"></i> Settings</h2>
        
        <div class="setting-item">
            <span class="setting-label"><i class="fas fa-sun"></i> Light Theme</span>
            <label class="toggle-switch">
                <input type="checkbox" id="themeToggle" onchange="handleSettingsChange(event)">
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-item">
            <span class="setting-label"><i class="fas fa-play-circle"></i> Use Alternative Player</span>
            <label class="toggle-switch">
                <input type="checkbox" id="playerTypeToggle" onchange="handleSettingsChange(event)">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="setting-item">
            <span class="setting-label"><i class="fas fa-expand"></i> Auto Landscape & Fullscreen</span>
            <label class="toggle-switch">
                <input type="checkbox" id="autoRotateToggle" onchange="handleSettingsChange(event)">
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-item" onclick="openCategorySorter()">
            <span class="setting-label"><i class="fas fa-list-ul"></i> Manage Category Order</span>
            <i class="fas fa-chevron-right" style="color:var(--text-secondary);"></i>
        </div>

        <div class="setting-item">
            <span class="setting-label"><i class="fas fa-maximize"></i> Zoom Video (Fill Screen)</span>
            <label class="toggle-switch">
                <input type="checkbox" id="screenFitToggle" onchange="handleSettingsChange(event)">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="setting-item" onclick="openProfileModal('privacy')">
            <span class="setting-label"><i class="fas fa-user-shield"></i> Privacy Policy</span>
            <i class="fas fa-chevron-right" style="color:var(--text-secondary);"></i>
        </div>

        <!-- Contact Support -->
        <div class="setting-item" onclick="openProfileModal('contact')">
            <span class="setting-label"><i class="fas fa-headset"></i> Contact Support</span>
            <i class="fas fa-chevron-right" style="color:var(--text-secondary);"></i>
        </div>

        <div class="setting-item" onclick="clearData()">
            <span class="setting-label" style="color: #E50914;"><i class="fas fa-trash-alt" style="color: #E50914;"></i> Reset App Data</span>
        </div>
    </div>
    
    <div id="see-all-page" class="content-page">
        <h2 class="page-title" id="see-all-title">Category</h2>
        <div class="content-grid" id="see-all-grid"></div>
    </div>

    <!-- PLAYER UI -->
    <div class="video-player" id="video-player">
        <button class="video-close" onclick="closeVideoPlayer()"><i class="fas fa-times"></i></button>
        
        <div class="video-wrapper">
            <!-- Plyr / Native Video Element -->
            <video id="video-element" playsinline controls preload="auto" style="width:100%; height:100%;"></video>
            
            <!-- VideoJS Element (Alternative) -->
            <video id="videojs-element" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" style="width:100%; height:100%; display:none;"></video>
            
            <!-- YOUTUBE PLAYER CONTAINER -->
            <div id="youtube-player-container" style="width:100%; height:100%; display:none;"></div>
            
            <div class="loader-container" id="loading-spinner"><div class="spinner"></div></div>
        </div>

        <div class="player-details-panel">
            <div class="pd-header-area">
                <div class="pd-title-row">
                    <img id="pd-logo" src="" class="pd-logo-img" onerror="this.src='https://via.placeholder.com/60'">
                    <div>
                        <h2 id="pd-title" class="pd-main-title">Loading...</h2>
                        <span id="pd-category" class="pd-sub-tag">Live TV</span>
                    </div>
                </div>
                <div class="pd-actions-row">
                    <button class="action-btn btn-fav" id="pd-fav-btn" onclick="toggleFavoriteFromDetail()">
                        <i class="far fa-heart"></i> Add to Favorites
                    </button>
                    <button class="action-btn btn-fav" id="pd-fullscreen-btn" onclick="triggerFullScreen()">
                        <i class="fas fa-expand"></i> Full Screen
                    </button>
                </div>
                <p id="pd-desc" style="font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-top: 15px;">
                    Loading detailed information...
                </p>
            </div>
            
            <div class="pd-content-area">
                <h3 style="font-size: 16px; color: var(--accent-color); margin-bottom: 15px; font-weight:700;">Channel Information</h3>
                <table id="pd-meta-table" class="meta-table"></table>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal-overlay" id="password-modal-overlay">
        <div class="custom-modal">
            <h3 style="color:var(--text-primary); margin-bottom:20px; text-align:center; font-size:20px;"><i class="fas fa-lock" style="color:var(--accent-color);"></i> Locked Channel</h3>
            <input type="password" id="modal-pass-input" placeholder="Enter Password" style="width:100%; padding:15px; background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); color:#fff; border-radius:12px; margin-bottom:25px; font-size:16px; text-align:center;">
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" onclick="closeModal('password-modal-overlay')">Cancel</button>
                <button class="modal-btn btn-confirm" id="modal-submit-btn">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Category Sort Modal -->
    <div class="modal-overlay" id="sort-modal-overlay">
        <div class="custom-modal">
            <h3 style="color:var(--text-primary); margin-bottom:5px; text-align:center; font-size:18px;">Reorder Categories</h3>
            <p style="font-size:12px; color:var(--text-secondary); text-align:center; margin-bottom:15px;">Organize your home screen feed</p>
            <div class="sort-list-container" id="sort-list-body"></div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" onclick="closeModal('sort-modal-overlay')">Cancel</button>
                <button class="modal-btn btn-confirm" onclick="saveCategoryOrder()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Profile & Privacy Policy Modal -->
    <div class="modal-overlay" id="profile-modal-overlay">
        <div class="custom-modal">
            <div class="profile-content-scroll">
                
                <div id="modal-section-privacy">
                    <div class="privacy-title">PRIVACY & POLICY</div>
                    
                    <p class="privacy-text">
                        ULTRA TV + හි ඔබගේ රහස්‍යතාව ආරක්ෂා කිරීම අපගේ ඉලක්කයයි. මෙයින් අපගේ ප්‍රතිපත්තිය හා භාවිතය පැහැදිලි කරයි.
                    </p>

                    <div class="disclaimer-box">
                        <span class="disclaimer-title"><i class="fas fa-exclamation-triangle"></i> DISCLAIMER</span>
                        <p class="disclaimer-text">
                            අපගේ වේදිකාව හුදෙක් තෙවන පාර්ශවයන්ගේ සේවාදායකයන් මත පිහිටා ඇති සහ තෙවන පාර්ශවයන් විසින් සපයනු ලබන සහ/හෝ සම්ප්‍රේෂණය කරන ලද ශ්‍රව්‍ය දෘශ්‍ය අන්තර්ගතයට සබැඳි සංදර්ශන කරයි. අපි කිසිදු ශ්‍රව්‍ය දෘශ්‍ය අන්තර්ගතයක් සත්කාරකත්වය හෝ සම්ප්‍රේෂණය නොකරන අතර එවැනි අන්තර්ගතයන් පාලනය හෝ බලපෑම් නොකරන්නෙමු.
                        </p>
                    </div>

                    <div class="disclaimer-box" style="background: rgba(229, 9, 20, 0.08); border-color: rgba(229, 9, 20, 0.2);">
                        <span class="disclaimer-title" style="color:var(--accent-color);"><i class="fas fa-shield-alt"></i> ULTRA POLICY</span>
                        <p class="disclaimer-text" style="color:var(--text-secondary);">
                             User data is processed securely in accordance with international standards. We ensure transparency in data collection and provide mechanisms for user control. This application prioritizes user safety and secure content delivery.
                        </p>
                    </div>

                    <p class="edu-note">
                        "මෙම යෙදුම විකිණීම සඳහා නොවේ/මෙය ANDROID පවුල සඳහා වේ. මෙය අධ්‍යාපනික ව්‍යාපෘතියක් පමණි."
                    </p>

                    <div class="about-footer">
                        <div class="about-name">Saman pushpa kumara</div>
                        <div class="about-loc"><i class="fas fa-map-marker-alt" style="color:var(--accent-color);"></i> Sri Lanka</div>
                    </div>
                </div>

                <div id="modal-section-contact" style="display:none;">
                    <div class="privacy-title">CONTACT SUPPORT</div>
                    
                    <div class="contact-section" style="border-top:none; margin-top:0;">
                        <a href="mailto:SPK2200@GMAIL.COM" class="contact-card">
                            <div class="contact-icon bg-email"><i class="fas fa-envelope"></i></div>
                            <div class="contact-info">
                                <div>Email Support</div>
                                <span>SPK2200@GMAIL.COM</span>
                            </div>
                        </a>

                        <a href="https://wa.me/qr/3ACKMAWBDLGJC1" target="_blank" class="contact-card">
                            <div class="contact-icon bg-whatsapp"><i class="fab fa-whatsapp"></i></div>
                            <div class="contact-info">
                                <div>WhatsApp</div>
                                <span>SPK MODS</span>
                            </div>
                        </a>
                    </div>
                </div>

            </div>

            <div class="modal-footer" style="margin-top:20px;">
                <button class="modal-btn btn-cancel" onclick="closeModal('profile-modal-overlay')" style="width:100%; border-color:var(--accent-color); color:var(--accent-color);">Close</button>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <div class="nav-bar">
        <a href="#" class="nav-item active" id="nav-home" onclick="navigateTo('home'); return false;"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="#" class="nav-item" id="nav-favorites" onclick="navigateTo('favorites'); return false;"><i class="fas fa-heart"></i><span>Favs</span></a>
        <a href="admin.html" class="nav-item" id="nav-admin"><i class="fas fa-user-shield"></i><span>Admin</span></a>
        <a href="#" class="nav-item" id="nav-setting" onclick="navigateTo('setting'); return false;"><i class="fas fa-cog"></i><span>Settings</span></a>
    </div>

    <script>
        // --- Country Map ---
        const countryMap = {
            'AF': 'Afghanistan', 'AL': 'Albania', 'DZ': 'Algeria', 'AS': 'American Samoa', 'AD': 'Andorra', 'AO': 'Angola', 
            'AI': 'Anguilla', 'AQ': 'Antarctica', 'AG': 'Antigua and Barbuda', 'AR': 'Argentina', 'AM': 'Armenia', 
            'AW': 'Aruba', 'AU': 'Australia', 'AT': 'Austria', 'AZ': 'Azerbaijan', 'BS': 'Bahamas', 'BH': 'Bahrain', 
            'BD': 'Bangladesh', 'BB': 'Barbados', 'BY': 'Belarus', 'BE': 'Belgium', 'BZ': 'Belize', 'BJ': 'Benin', 
            'BM': 'Bermuda', 'BT': 'Bhutan', 'BO': 'Bolivia', 'BQ': 'Bonaire', 
            'BA': 'Bosnia', 'BW': 'Botswana', 'BV': 'Bouvet Island', 'BR': 'Brazil', 'IO': 'British Indian Ocean Territory', 
            'BN': 'Brunei', 'BG': 'Bulgaria', 'BF': 'Burkina Faso', 'BI': 'Burundi', 'CV': 'Cabo Verde', 
            'KH': 'Cambodia', 'CM': 'Cameroon', 'CA': 'Canada', 'KY': 'Cayman Islands', 'CF': 'Central African Republic', 
            'TD': 'Chad', 'CL': 'Chile', 'CN': 'China', 'CX': 'Christmas Island', 'CC': 'Cocos', 
            'CO': 'Colombia', 'KM': 'Comoros', 'CD': 'DR Congo', 'CG': 'Congo', 'CK': 'Cook Islands', 
            'CR': 'Costa Rica', 'HR': 'Croatia', 'CU': 'Cuba', 'CW': 'Curaçao', 'CY': 'Cyprus', 'CZ': 'Czechia', 
            'CI': 'Ivory Coast', 'DK': 'Denmark', 'DJ': 'Djibouti', 'DM': 'Dominica', 'DO': 'Dominican Republic', 
            'EC': 'Ecuador', 'EG': 'Egypt', 'SV': 'El Salvador', 'GQ': 'Equatorial Guinea', 'ER': 'Eritrea', 'EE': 'Estonia', 
            'SZ': 'Eswatini', 'ET': 'Ethiopia', 'FK': 'Falkland Islands', 'FO': 'Faroe Islands', 'FJ': 'Fiji', 
            'FI': 'Finland', 'FR': 'France', 'GF': 'French Guiana', 'PF': 'French Polynesia', 'TF': 'French Southern Territories', 
            'GA': 'Gabon', 'GM': 'Gambia', 'GE': 'Georgia', 'DE': 'Germany', 'GH': 'Ghana', 'GI': 'Gibraltar', 
            'GR': 'Greece', 'GL': 'Greenland', 'GD': 'Grenada', 'GP': 'Guadeloupe', 'GU': 'Guam', 'GT': 'Guatemala', 
            'GG': 'Guernsey', 'GN': 'Guinea', 'GW': 'Guinea-Bissau', 'GY': 'Guyana', 'HT': 'Haiti', 'HM': 'Heard Island', 
            'VA': 'Holy See', 'HN': 'Honduras', 'HK': 'Hong Kong', 'HU': 'Hungary', 'IS': 'Iceland', 'IN': 'India', 
            'ID': 'Indonesia', 'IR': 'Iran', 'IQ': 'Iraq', 'IE': 'Ireland', 'IM': 'Isle of Man', 
            'IL': 'Israel', 'IT': 'Italy', 'JM': 'Jamaica', 'JP': 'Japan', 'JE': 'Jersey', 'JO': 'Jordan', 'KZ': 'Kazakhstan', 
            'KE': 'Kenya', 'KI': 'Kiribati', 'KP': 'North Korea', 'KR': 'South Korea', 
            'KW': 'Kuwait', 'KG': 'Kyrgyzstan', 'LA': 'Laos', 'LV': 'Latvia', 'LB': 'Lebanon', 
            'LS': 'Lesotho', 'LR': 'Liberia', 'LY': 'Libya', 'LI': 'Liechtenstein', 'LT': 'Lithuania', 'LU': 'Luxembourg', 
            'MO': 'Macao', 'MG': 'Madagascar', 'MW': 'Malawi', 'MY': 'Malaysia', 'MV': 'Maldives', 'ML': 'Mali', 
            'MT': 'Malta', 'MH': 'Marshall Islands', 'MQ': 'Martinique', 'MR': 'Mauritania', 'MU': 'Mauritius', 'YT': 'Mayotte', 
            'MX': 'Mexico', 'FM': 'Micronesia', 'MD': 'Moldova', 'MC': 'Monaco', 
            'MN': 'Mongolia', 'ME': 'Montenegro', 'MS': 'Montserrat', 'MA': 'Morocco', 'MZ': 'Mozambique', 'MM': 'Myanmar', 
            'NA': 'Namibia', 'NR': 'Nauru', 'NP': 'Nepal', 'NL': 'Netherlands', 'NC': 'New Caledonia', 'NZ': 'New Zealand', 
            'NI': 'Nicaragua', 'NE': 'Niger', 'NG': 'Nigeria', 'NU': 'Niue', 'NF': 'Norfolk Island', 'MP': 'Northern Mariana Islands', 
            'NO': 'Norway', 'OM': 'Oman', 'PK': 'Pakistan', 'PW': 'Palau', 'PS': 'Palestine', 'PA': 'Panama', 
            'PG': 'Papua New Guinea', 'PY': 'Paraguay', 'PE': 'Peru', 'PH': 'Philippines', 'PN': 'Pitcairn', 'PL': 'Poland', 
            'PT': 'Portugal', 'PR': 'Puerto Rico', 'QA': 'Qatar', 'MK': 'North Macedonia', 'RO': 'Romania', 
            'RU': 'Russia', 'RW': 'Rwanda', 'RE': 'Réunion', 'BL': 'Saint Barthélemy', 'SH': 'Saint Helena', 
            'KN': 'Saint Kitts and Nevis', 'LC': 'Saint Lucia', 'MF': 'Saint Martin', 'PM': 'Saint Pierre and Miquelon', 
            'VC': 'Saint Vincent', 'WS': 'Samoa', 'SM': 'San Marino', 'ST': 'Sao Tome', 
            'SA': 'Saudi Arabia', 'SN': 'Senegal', 'RS': 'Serbia', 'SC': 'Seychelles', 'SL': 'Sierra Leone', 'SG': 'Singapore', 
            'SX': 'Sint Maarten', 'SK': 'Slovakia', 'SI': 'Slovenia', 'SB': 'Solomon Islands', 'SO': 'Somalia', 
            'ZA': 'South Africa', 'GS': 'South Georgia', 'SS': 'South Sudan', 'ES': 'Spain', 
            'LK': 'Sri Lanka', 'SD': 'Sudan', 'SR': 'Suriname', 'SJ': 'Svalbard', 'SE': 'Sweden', 'CH': 'Switzerland', 
            'SY': 'Syria', 'TW': 'Taiwan', 'TJ': 'Tajikistan', 'TZ': 'Tanzania', 'TH': 'Thailand', 
            'TL': 'Timor-Leste', 'TG': 'Togo', 'TK': 'Tokelau', 'TO': 'Tonga', 'TT': 'Trinidad and Tobago', 'TN': 'Tunisia', 
            'TR': 'Turkey', 'TM': 'Turkmenistan', 'TC': 'Turks and Caicos', 'TV': 'Tuvalu', 'UG': 'Uganda', 
            'UA': 'Ukraine', 'AE': 'UAE', 'GB': 'United Kingdom', 
            'US': 'USA', 'UM': 'US Minor Outlying Islands', 'UY': 'Uruguay', 'UZ': 'Uzbekistan', 
            'VU': 'Vanuatu', 'VE': 'Venezuela', 'VN': 'Vietnam', 'VG': 'British Virgin Islands', 
            'VI': 'US Virgin Islands', 'WF': 'Wallis and Futuna', 'EH': 'Western Sahara', 'YE': 'Yemen', 'ZM': 'Zambia', 
            'ZW': 'Zimbabwe', 'AX': 'Åland Islands'
        };

        const getFullCountryName = (code) => countryMap[code.toUpperCase()] || code;

        // --- FIREBASE CONFIGURATION (Replaced Supabase) ---
        const firebaseConfig = {
          apiKey: "AIzaSyAlcwOpOwSdxDvPmzt3S8Vo6j2x0Q3wIj4",
          authDomain: "ultra-tv-891f4.firebaseapp.com",
          databaseURL: "https://ultra-tv-891f4-default-rtdb.firebaseio.com",
          projectId: "ultra-tv-891f4",
          storageBucket: "ultra-tv-891f4.firebasestorage.app",
          messagingSenderId: "1024440384778",
          appId: "1:1024440384778:web:fde449bc0c7ea0357dcef3"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Variables ---
        let allChannels = {};
        let iptvData = [];
        let currentChannelKey = null;
        let posterInterval;
        let globalNotificationData = null; 
        let settings = JSON.parse(localStorage.getItem('tvSettings')) || { 
            screenFit: false, 
            lightTheme: false, 
            useAltPlayer: false,
            autoRotate: false
        };
        let favorites = JSON.parse(localStorage.getItem('tvFavorites')) || [];
        let categoryOrder = JSON.parse(localStorage.getItem('tvCatOrder')) || [];

        // Players
        let hlsInstance = null;
        let plyrInstance = null;
        let vjsPlayer = null;
        let tempCategoryOrder = [];

        // Apply Initial Settings
        if(settings.lightTheme) document.body.classList.add('light-theme');
        if(settings.screenFit) document.querySelector('.video-wrapper').classList.add('fill-mode');
        document.getElementById('screenFitToggle').checked = settings.screenFit;
        document.getElementById('themeToggle').checked = settings.lightTheme;
        document.getElementById('playerTypeToggle').checked = settings.useAltPlayer;
        document.getElementById('autoRotateToggle').checked = settings.autoRotate;

        // Fetch Metadata
        fetch('https://iptv-org.github.io/api/channels.json')
            .then(res => res.json())
            .then(data => { iptvData = data; console.log('Metadata Loaded'); startPosterLoop(); })
            .catch(e => console.error("Metadata Load Error:", e));

        const getChannelMeta = (ch) => {
            let meta = {};
            if(ch.tvgId && iptvData.length > 0) {
                meta = iptvData.find(i => i.id === ch.tvgId) || {};
            } else if (iptvData.length > 0) {
                const cleanName = (ch.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                meta = iptvData.find(i => (i.name || '').toLowerCase().replace(/[^a-z0-9]/g, '') === cleanName) || {};
            }
            return meta;
        };

        // --- Core Functions ---
        window.navigateTo = (pageId) => {
            window.history.pushState({page: pageId}, '', `#${pageId}`);
            document.querySelectorAll('.content-page, #home-page').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById(pageId + '-page') || document.getElementById('home-page');
            target.style.display = 'block';
            
            const navEl = document.getElementById('nav-' + pageId);
            if(navEl) navEl.classList.add('active');
            
            if(pageId === 'home') {
                document.getElementById('main-header').style.display = 'flex';
                renderCategories();
            } else {
                if(pageId !== 'see-all') document.getElementById('main-header').style.display = 'none';
            }
            
            if(pageId === 'favorites') {
                const favs = favorites.map(k => ({key: k, ...allChannels[k]})).filter(c => c.name);
                renderGrid('favorites-grid', favs);
            }
            window.scrollTo(0,0);
        };

        window.history.replaceState({page: 'home'}, '', '#home');

        window.onpopstate = (event) => {
            if(document.getElementById('video-player').style.display === 'flex') {
                closeVideoPlayer();
                return;
            }
            if(document.querySelector('.modal-overlay.active')) {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
                return;
            }
            if (event.state && event.state.page) {
                const pageId = event.state.page;
                document.querySelectorAll('.content-page, #home-page').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                
                const target = document.getElementById(pageId + '-page') || document.getElementById('home-page');
                if(target) target.style.display = 'block';
                
                const navEl = document.getElementById('nav-' + pageId);
                if(navEl) navEl.classList.add('active');

                if(pageId === 'home') document.getElementById('main-header').style.display = 'flex';
                else if(pageId !== 'see-all') document.getElementById('main-header').style.display = 'none';
            } else {
                document.querySelectorAll('.content-page, #home-page').forEach(el => el.style.display = 'none');
                document.getElementById('home-page').style.display = 'block';
                document.getElementById('main-header').style.display = 'flex';
                document.getElementById('nav-home').classList.add('active');
            }
        };

        const createCard = (key, ch) => {
            const isFav = favorites.includes(key);
            return `
            <div class="channel-card" onclick="playChannel('${key}')">
                <div class="card-live-badge">LIVE</div>
                <i class="fas fa-heart favorite-icon ${isFav ? 'is-favorite' : ''}" onclick="event.stopPropagation(); toggleFav('${key}')"></i>
                <img src="${ch.iconUrl || 'https://via.placeholder.com/60'}" class="channel-image" loading="lazy" onerror="this.src='https://via.placeholder.com/60'">
                <div class="channel-name">${ch.name} ${ch.password ? '<i class="fas fa-lock" style="font-size:9px; color:#ff4757"></i>' : ''}</div>
            </div>`;
        };

        const renderCategories = (search = '') => {
            const container = document.getElementById('channel-categories-container');
            
            if(Object.keys(allChannels).length === 0) {
                 container.innerHTML = '<p style="text-align:center; padding:40px; color:var(--text-secondary);"><i class="fas fa-circle-notch fa-spin"></i> Loading Channels...</p>';
                 return;
            }

            const list = Object.keys(allChannels).map(k => ({key:k, ...allChannels[k]}));
            const filtered = search ? list.filter(c => c.name.toLowerCase().includes(search.toLowerCase())) : list;
            
            if(filtered.length === 0) {
                 container.innerHTML = '<p style="text-align:center; padding:40px; color:var(--text-secondary);">No channels found matching your search.</p>';
                 return;
            }

            const grouped = filtered.reduce((acc, c) => {
                const cat = c.category || 'Others';
                if(!acc[cat]) acc[cat] = [];
                acc[cat].push(c);
                return acc;
            }, {});

            let keys = Object.keys(grouped);
            if(categoryOrder.length > 0) {
                keys.sort((a, b) => {
                    const idxA = categoryOrder.indexOf(a);
                    const idxB = categoryOrder.indexOf(b);
                    if (idxA === -1 && idxB === -1) return 0;
                    if (idxA === -1) return 1;
                    if (idxB === -1) return -1;
                    return idxA - idxB;
                });
            }

            let html = '';
            keys.forEach(cat => {
                grouped[cat].sort((a, b) => {
                    let orderA = a.orderIndex !== undefined && a.orderIndex !== null && a.orderIndex !== "" ? parseInt(a.orderIndex) : 999999;
                    let orderB = b.orderIndex !== undefined && b.orderIndex !== null && b.orderIndex !== "" ? parseInt(b.orderIndex) : 999999;
                    if (orderA !== orderB) return orderA - orderB;
                    return (a.name || "").localeCompare(b.name || "");
                });

                const safeCat = cat.replace(/'/g, "\\'");
                html += `
                <div class="category-section">
                    <div class="category-header">
                        <span class="category-title">${cat}</span>
                        <a class="see-all" onclick="openSeeAll('${safeCat}')">See All</a>
                    </div>
                    <div class="channel-slider">
                        ${grouped[cat].map(c => createCard(c.key, c)).join('')}
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        };

        const renderGrid = (id, items) => { document.getElementById(id).innerHTML = items.map(c => createCard(c.key, c)).join(''); };
        window.searchContent = () => renderCategories(document.getElementById('search-input').value);
        
        window.openSeeAll = (cat) => {
            const items = Object.keys(allChannels)
                .map(k => ({key:k, ...allChannels[k]}))
                .filter(c => (c.category || 'Others') === cat)
                .sort((a, b) => {
                    let orderA = a.orderIndex !== undefined && a.orderIndex !== null && a.orderIndex !== "" ? parseInt(a.orderIndex) : 999999;
                    let orderB = b.orderIndex !== undefined && b.orderIndex !== null && b.orderIndex !== "" ? parseInt(b.orderIndex) : 999999;
                    if (orderA !== orderB) return orderA - orderB;
                    return (a.name || "").localeCompare(b.name || "");
                });
            
            document.getElementById('see-all-title').innerText = cat;
            renderGrid('see-all-grid', items);
            window.navigateTo('see-all');
        };

        window.openCategorySorter = () => {
            const currentCats = [...new Set(Object.values(allChannels).map(c => c.category || 'Others'))];
            tempCategoryOrder = [...new Set([...categoryOrder, ...currentCats])].filter(c => currentCats.includes(c));
            renderSortList();
            document.getElementById('sort-modal-overlay').classList.add('active');
            window.history.pushState({modal: 'sort'}, '', '#sort-categories');
        };

        const renderSortList = () => {
            const body = document.getElementById('sort-list-body');
            body.innerHTML = tempCategoryOrder.map((cat, idx) => `
                <div class="sort-item">
                    <span style="font-weight:600; font-size:13px; color:var(--text-primary);">${cat}</span>
                    <div class="sort-controls">
                        <button class="sort-btn" onclick="moveCategory(${idx}, -1)"><i class="fas fa-arrow-up"></i></button>
                        <button class="sort-btn" onclick="moveCategory(${idx}, 1)"><i class="fas fa-arrow-down"></i></button>
                    </div>
                </div>
            `).join('');
        };

        window.moveCategory = (index, dir) => {
            if (dir === -1 && index > 0) {
                [tempCategoryOrder[index], tempCategoryOrder[index-1]] = [tempCategoryOrder[index-1], tempCategoryOrder[index]];
            } else if (dir === 1 && index < tempCategoryOrder.length - 1) {
                [tempCategoryOrder[index], tempCategoryOrder[index+1]] = [tempCategoryOrder[index+1], tempCategoryOrder[index]];
            }
            renderSortList();
        };

        window.saveCategoryOrder = () => {
            categoryOrder = tempCategoryOrder;
            localStorage.setItem('tvCatOrder', JSON.stringify(categoryOrder));
            closeModal('sort-modal-overlay');
            renderCategories();
            window.history.back(); 
        };

        window.openProfileModal = (mode) => {
            const privacySec = document.getElementById('modal-section-privacy');
            const contactSec = document.getElementById('modal-section-contact');

            if(mode === 'contact') {
                privacySec.style.display = 'none';
                contactSec.style.display = 'block';
            } else {
                privacySec.style.display = 'block';
                contactSec.style.display = 'none';
            }

            document.getElementById('profile-modal-overlay').classList.add('active');
            window.history.pushState({modal: 'profile'}, '', '#info');
        };

        const startPosterLoop = () => {
            const slider = document.getElementById('poster-slider');
            
            // Notification Check
            let notiMsg = "";
            let notiImg = "";

            if (globalNotificationData) {
                if (typeof globalNotificationData === 'object') {
                    notiMsg = globalNotificationData.message || globalNotificationData.text || globalNotificationData.msg || "";
                    notiImg = globalNotificationData.image || globalNotificationData.img || globalNotificationData.url || "";
                } else {
                    notiMsg = globalNotificationData;
                }
            }

            if(notiMsg) {
                const displayImg = notiImg ? notiImg : "https://img.freepik.com/free-vector/gradient-breaking-news-background_23-2151113828.jpg";

                slider.innerHTML = `
                <div class="poster-slide">
                    <img src="${displayImg}" style="filter: brightness(0.6);">
                    <div class="slide-overlay">
                        <div class="slide-tag" style="background:var(--accent-color); color:#fff;">ANNOUNCEMENT</div>
                        <div class="slide-title" style="font-size: 24px; line-height: 1.4;">${notiMsg}</div>
                    </div>
                </div>`;

                if(posterInterval) clearInterval(posterInterval);
                slider.style.transform = `translateX(0%)`;
                return; 
            }

            if(Object.keys(allChannels).length === 0) return;

            let list = Object.keys(allChannels).map(k => ({key:k, ...allChannels[k]}));
            list = list.filter(c => {
                const cat = (c.category || '').toLowerCase();
                const name = (c.name || '').toLowerCase();
                if(cat.includes('adult') || cat.includes('porn') || cat.includes('xxx') || cat.includes('18+') || cat.includes('nsfw')) return false;
                if(name.includes('adult') || name.includes('porn') || name.includes('xxx')) return false;
                return true;
            });

            const shuffled = list.sort(() => 0.5 - Math.random());
            const random10 = shuffled.slice(0, 10);
            
            let slidesHtml = random10.map(c => {
                const meta = getChannelMeta(c); 
                let catName = c.category; 
                if(!catName && meta.categories && meta.categories.length > 0) catName = meta.categories[0];
                if(!catName) catName = "Live TV";
                let cntName = "International";
                if(meta.country) cntName = getFullCountryName(meta.country);

                return `
                <div class="poster-slide" onclick="playChannel('${c.key}')">
                    <img src="${c.backdropUrl || c.iconUrl}" onerror="this.src='https://via.placeholder.com/400x220?text=${c.name}'">
                    <div class="slide-overlay">
                        <div class="slide-tag">FEATURED</div>
                        <div class="slide-title">${c.name}</div>
                        <div style="font-size: 13px; font-weight: 400; color: #d4d4d4; text-shadow: 0 1px 5px rgba(0,0,0,0.8); margin-top: 2px;">
                            ${catName} • ${cntName}
                        </div>
                    </div>
                </div>`;
            }).join('');

            slider.innerHTML = slidesHtml;
            
            if(posterInterval) clearInterval(posterInterval);
            let idx = 0;
            const totalSlides = random10.length;

            if(totalSlides > 1) {
                posterInterval = setInterval(() => {
                    idx = (idx + 1) % totalSlides;
                    slider.style.transform = `translateX(-${idx * 100}%)`;
                }, 5000);
            } else {
                 slider.style.transform = `translateX(0%)`;
            }
        };

        window.playChannel = (key) => {
            const ch = allChannels[key];
            if(ch.password) openPassModal(key, ch.password);
            else startPlayer(key);
        };

        function getYoutubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        const startPlayer = (key) => {
            window.history.pushState({page: 'player'}, '', '#player');
            const ch = allChannels[key];
            currentChannelKey = key;
            
            const playerDiv = document.getElementById('video-player');
            const nativeVideo = document.getElementById('video-element');
            const vjsTag = document.getElementById('videojs-element');
            const ytContainer = document.getElementById('youtube-player-container');
            
            playerDiv.style.display = 'flex';
            document.getElementById('loading-spinner').style.display = 'flex';
            
            document.getElementById('pd-title').innerText = ch.name;
            document.getElementById('pd-category').innerText = ch.category || 'Live TV';
            document.getElementById('pd-logo').src = ch.iconUrl;
            
            if(settings.autoRotate) {
                triggerFullScreen();
            }
            
            updateFavBtnState(key);
            renderMetaData(ch); 

            const url = ch.streamUrl;

            // RESET PLAYERS
            nativeVideo.style.display = 'none'; nativeVideo.pause();
            vjsTag.style.display = 'none';
            ytContainer.style.display = 'none';
            ytContainer.innerHTML = ''; 
            
            if(hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
            if(plyrInstance) { plyrInstance.destroy(); plyrInstance = null; }
            if(vjsPlayer) { vjsPlayer.dispose(); vjsPlayer = null; }

            const ytId = getYoutubeId(url);
            if(ytId) {
                ytContainer.style.display = 'block';
                document.getElementById('loading-spinner').style.display = 'none';
                ytContainer.innerHTML = `
                    <iframe 
                        src="https://www.youtube.com/embed/${ytId}?autoplay=1&mute=0&controls=1"
                        title="YouTube video player"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen
                        style="width:100%; height:100%; border:0;">
                    </iframe>
                `;
                return; 
            }

            if(settings.useAltPlayer) {
                vjsTag.style.display = 'block';
                vjsPlayer = videojs('videojs-element', { 
                    autoplay: true, 
                    controls: true,
                    fluid: true,
                    sources: [{ src: url }] 
                });
                vjsPlayer.on('playing', () => document.getElementById('loading-spinner').style.display = 'none');
                vjsPlayer.on('error', () => { 
                    console.error("VideoJS Error");
                    document.getElementById('loading-spinner').style.display = 'none';
                    alert("Player Error. Try switching off Alternative Player in Settings.");
                });
                return;
            }

            nativeVideo.style.display = 'block';
            
            const defaultOptions = {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'fullscreen'],
                settings: ['quality', 'speed'],
                quality: { default: 720, options: [1080, 720, 480, 360] }
            };

            if (Hls.isSupported() && (url.includes('.m3u8') || url.includes('.ts'))) {
                hlsInstance = new Hls();
                hlsInstance.loadSource(url);
                hlsInstance.attachMedia(nativeVideo);
                
                hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                    const levels = hlsInstance.levels.map((l, i) => l.height);
                    defaultOptions.quality = {
                        default: levels[levels.length-1],
                        options: levels,
                        forced: true,
                        onChange: (newQuality) => {
                            hlsInstance.levels.forEach((level, levelIndex) => {
                                if (level.height === newQuality) {
                                    hlsInstance.currentLevel = levelIndex;
                                }
                            });
                        }
                    };
                    plyrInstance = new Plyr(nativeVideo, defaultOptions);
                    nativeVideo.play().catch(e => console.log("Autoplay blocked", e));
                    document.getElementById('loading-spinner').style.display = 'none';
                });
                
                hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error("HLS Fatal Error:", data);
                        document.getElementById('loading-spinner').style.display = 'none';
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                hlsInstance.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                hlsInstance.recoverMediaError();
                                break;
                            default:
                                hlsInstance.destroy();
                                break;
                        }
                    }
                });
            } else {
                nativeVideo.src = url;
                plyrInstance = new Plyr(nativeVideo, defaultOptions);
                nativeVideo.play().catch(e => console.log("Autoplay blocked", e));
                nativeVideo.onplaying = () => document.getElementById('loading-spinner').style.display = 'none';
                if(url.includes('.mp3') || url.includes('.aac') || url.includes('.m4a')) {
                     nativeVideo.poster = ch.iconUrl; 
                }
            }
        };

        document.addEventListener("visibilitychange", async () => {
            if (document.visibilityState === "hidden") {
                const video = document.getElementById("video-element");
                if (video && !video.paused && document.getElementById('video-player').style.display === 'flex') {
                    try {
                        if (document.pictureInPictureEnabled && !document.pictureInPictureElement) {
                            await video.requestPictureInPicture();
                        }
                    } catch (err) {
                        console.log("PiP failed:", err);
                    }
                }
            }
        });

        window.closeVideoPlayer = () => {
            const playerDiv = document.getElementById('video-player');
            playerDiv.classList.remove('force-landscape');
            
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                if(document.exitFullscreen) document.exitFullscreen();
                else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
            }

            document.querySelector('.player-details-panel').style.display = 'block';
            document.querySelector('.video-wrapper').style.height = '35vh';

            const btn = document.getElementById('pd-fullscreen-btn');
            if(btn) {
                btn.classList.remove('btn-share');
                btn.classList.add('btn-fav');
                btn.innerHTML = '<i class="fas fa-expand"></i> Full Screen';
            }

            playerDiv.style.display = 'none';
            const v = document.getElementById('video-element'); 
            v.pause(); 
            v.src = "";
            
            document.getElementById('youtube-player-container').innerHTML = '';
            document.getElementById('youtube-player-container').style.display = 'none';
            
            if(hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
            if(plyrInstance) { plyrInstance.destroy(); plyrInstance = null; }
            if(vjsPlayer) { vjsPlayer.dispose(); vjsPlayer = null; }
            
            if(window.history.state && window.history.state.page === 'player') {
                window.history.back();
            }
        };

        const renderMetaData = (ch) => {
            const meta = getChannelMeta(ch); 
            let autoDesc = ch.description || "";
            if (!autoDesc) {
                const cName = ch.name;
                const cCat = (meta.categories && meta.categories.length) ? meta.categories.join(', ') : (ch.category || 'TV');
                const cCountry = meta.country ? getFullCountryName(meta.country) : 'International';
                autoDesc = `Watch ${cName}, a popular ${cCat} channel from ${cCountry}. Enjoy high quality streaming on Ultra TV.`;
            }
            document.getElementById('pd-desc').innerText = autoDesc;

            const fields = [
                { key: 'id', label: 'Channel ID' },
                { key: 'owners', label: 'Owner' },
                { key: 'country', label: 'Country' },
                { key: 'categories', label: 'Category' },
                { key: 'launched', label: 'Launched' },
                { key: 'website', label: 'Website' }
            ];

            const table = document.getElementById('pd-meta-table');
            let rows = '';
            
            fields.forEach(field => {
                let val = meta[field.key];
                if (field.key === 'country' && val) val = getFullCountryName(val);
                if (Array.isArray(val)) val = val.join(', ');
                if (val === undefined || val === null || val === '') val = '<span style="color:var(--text-secondary); font-style:italic;">N/A</span>';
                if (field.key === 'website' && !val.includes('N/A')) val = `<a href="${val}" target="_blank" style="color:var(--accent-color); text-decoration:none; font-weight:600;">Visit Link <i class="fas fa-external-link-alt" style="font-size:10px;"></i></a>`;
                rows += `<tr><td>${field.label}</td><td>${val}</td></tr>`;
            });
            table.innerHTML = rows;
        };

        window.triggerFullScreen = () => {
            const playerDiv = document.getElementById('video-player');
            const btn = document.getElementById('pd-fullscreen-btn');
            const isRotated = playerDiv.classList.contains('force-landscape');
            
            if (!isRotated) {
                playerDiv.classList.add('force-landscape');
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                }
                
                if(btn) {
                    btn.classList.remove('btn-fav');
                    btn.classList.add('btn-share');
                    btn.innerHTML = '<i class="fas fa-compress"></i> Exit Rotate';
                }

            } else {
                playerDiv.classList.remove('force-landscape');
                if (document.exitFullscreen) {
                    document.exitFullscreen().catch(e => console.log(e));
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                
                if(btn) {
                    btn.classList.remove('btn-share');
                    btn.classList.add('btn-fav');
                    btn.innerHTML = '<i class="fas fa-expand"></i> Full Screen';
                }
            }
            window.dispatchEvent(new Event('resize'));
        };

        window.handleSettingsChange = (e) => {
            if(e.target.id === 'themeToggle') {
                settings.lightTheme = e.target.checked;
                document.body.classList.toggle('light-theme', settings.lightTheme);
            }
            if(e.target.id === 'screenFitToggle') {
                settings.screenFit = e.target.checked;
                document.querySelector('.video-wrapper').classList.toggle('fill-mode', settings.screenFit);
            }
            if(e.target.id === 'playerTypeToggle') {
                settings.useAltPlayer = e.target.checked;
                localStorage.setItem('tvSettings', JSON.stringify(settings));
                location.reload(); 
                return;
            }
            if(e.target.id === 'autoRotateToggle') settings.autoRotate = e.target.checked;
            
            localStorage.setItem('tvSettings', JSON.stringify(settings));
        };

        window.toggleFav = (key) => {
            if(favorites.includes(key)) favorites = favorites.filter(k => k !== key);
            else favorites.push(key);
            localStorage.setItem('tvFavorites', JSON.stringify(favorites));
            if(document.getElementById('favorites-page').style.display === 'block') window.navigateTo('favorites');
            else renderCategories(document.getElementById('search-input').value);
            updateFavBtnState(key);
        };
        window.toggleFavoriteFromDetail = () => { if(currentChannelKey) window.toggleFav(currentChannelKey); };
        const updateFavBtnState = (key) => {
            if(currentChannelKey !== key) return;
            const isFav = favorites.includes(key);
            const btn = document.getElementById('pd-fav-btn');
            if(btn) {
                btn.className = isFav ? 'action-btn btn-fav active' : 'action-btn btn-fav';
                btn.innerHTML = isFav ? '<i class="fas fa-heart"></i> Favorited' : '<i class="far fa-heart"></i> Add to Favorites';
            }
        };

        window.clearData = () => { if(confirm('Are you sure you want to reset all data? This cannot be undone.')) { localStorage.clear(); location.reload(); }};
        
        let pendingKey, pendingPass;
        window.openPassModal = (k, p) => { 
            pendingKey = k; pendingPass = p; 
            document.getElementById('modal-pass-input').value = ''; 
            document.getElementById('password-modal-overlay').classList.add('active'); 
            window.history.pushState({modal: 'password'}, '', '#unlock');
            setTimeout(() => document.getElementById('modal-pass-input').focus(), 100);
        };
        window.closeModal = (id) => {
             document.getElementById(id).classList.remove('active');
             if(window.history.state && window.history.state.modal) window.history.back();
        };

        document.getElementById('modal-submit-btn').onclick = () => {
            const input = document.getElementById('modal-pass-input').value;
            if(input === pendingPass) { 
                closeModal('password-modal-overlay');
                setTimeout(() => {
                    startPlayer(pendingKey);
                }, 300);
            } else {
                alert('Incorrect Password! Access Denied.');
            }
        };

        // --- FIREBASE DATA FETCHING LOGIC ---

        // Fetch Channels Realtime
        const channelsRef = firebase.database().ref('channels');
        channelsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                allChannels = {};
                // Normalize data whether it's an object or array in Firebase
                for (let key in data) {
                    if (data.hasOwnProperty(key)) {
                        let item = data[key];
                        // Ensure ID is a string for internal logic compatibility
                        let strId = String(item.id || key);
                        allChannels[strId] = { ...item, key: strId, id: strId };
                    }
                }
                console.log('Channels updated from Firebase');
                renderCategories(document.getElementById('search-input').value);
                startPosterLoop();
            } else {
                document.getElementById('channel-categories-container').innerHTML = `<p style="text-align:center; padding:20px; color:#ff4757;">No channels found.</p>`;
            }
        }, (error) => {
            console.error('Error fetching channels:', error);
            document.getElementById('channel-categories-container').innerHTML = `<p style="text-align:center; padding:20px; color:#ff4757;">Error loading data.</p>`;
        });

        // Fetch Notifications Realtime
        const notiRef = firebase.database().ref('notification');
        notiRef.on('value', (snapshot) => {
            const data = snapshot.val();
            // Original code expected a single object or list. Handle accordingly.
            globalNotificationData = data;
            console.log('Notification updated from Firebase');
            startPosterLoop();
        });

    </script>
</body>
    </html>
