<div></div><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FluxTV Premium - Professional Streaming Experience</title>
    
    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <!-- Firebase SDK (Version 8 Compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Styles & Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Premium Color Palette */
            --primary-color: #1a2332;      /* Deep Navy */
            --secondary-color: #0d9488;    /* Rich Teal */
            --accent-color: #d4af37;       /* Rich Gold */
            --accent-secondary: #c77dff;   /* Elegant Purple */
            --success-color: #059669;      /* Professional Green */
            --danger-color: #dc2626;       /* Refined Red */
            --warning-color: #d97706;      /* Warm Orange */
            
            /* Light Theme UI - Premium Edition */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --surface: #ffffff;
            --surface-elevated: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1a232;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --text-accent: #d4af37;
            --shadow: 0 2px 8px 0 rgba(26, 35, 50, 0.08), 0 1px 3px 0 rgba(26, 35, 50, 0.04);
            --shadow-lg: 0 12px 24px -6px rgba(26, 35, 50, 0.12), 0 4px 8px -2px rgba(26, 35, 50, 0.06);
            --shadow-xl: 0 24px 48px -12px rgba(26, 35, 50, 0.18), 0 8px 16px -4px rgba(26, 35, 50, 0.08);
            --gradient-primary: linear-gradient(135deg, #1a2332 0%, #2d3748 100%);
            --gradient-accent: linear-gradient(135deg, #d4af37 0%, #f6e05e 100%);
            --gradient-teal: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            
            /* Dark Theme Colors - Luxurious Dark */
            --dark-bg-primary: #0a0f1a;
            --dark-bg-secondary: #1a2332;
            --dark-bg-tertiary: #2d3748;
            --dark-surface: #1a2332;
            --dark-surface-elevated: #2d3748;
            --dark-border-color: #374151;
            --dark-text-primary: #f8fafc;
            --dark-text-secondary: #cbd5e1;
            --dark-text-muted: #64748b;
            
            /* App Specific */
            --header-height: 60px;
            --bottom-nav-height: 70px;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            --z-header: 1000;
            --z-modal: 1100;
            --z-toast: 1200;
            --z-mini-player: 900;
        }

        /* Dark theme variables when applied */
        [data-theme="dark"] {
            --bg-primary: var(--dark-bg-primary);
            --bg-secondary: var(--dark-bg-secondary);
            --bg-tertiary: var(--dark-bg-tertiary);
            --surface: var(--dark-surface);
            --surface-elevated: var(--dark-surface-elevated);
            --border-color: var(--dark-border-color);
            --text-primary: var(--dark-text-primary);
            --text-secondary: var(--dark-text-secondary);
            --text-muted: var(--dark-text-muted);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: var(--transition);
            padding-bottom: env(safe-area-inset-bottom);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* App Container */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--bg-primary);
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            height: var(--header-height);
            background: var(--surface);
            background-image: linear-gradient(135deg, var(--surface) 0%, var(--bg-secondary) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            z-index: var(--z-header);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 800;
            background: var(--gradient-accent);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
        }

        .logo i {
            font-size: 1.5rem;
            background: var(--gradient-accent);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .header-btn:hover,
        .header-btn:active {
            background: var(--primary-color);
            color: white;
            transform: scale(0.95);
        }

        .header-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Search Bar */
        .search-container {
            position: relative;
            flex: 1;
            max-width: 300px;
            margin: 0 1rem;
        }

        .search-input {
            width: 100%;
            height: 40px;
            padding: 0 1rem 0 2.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.12);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-clear {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: none;
        }

        .search-clear.show {
            display: block;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding-bottom: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom));
            position: relative;
        }

        .screen {
            display: none;
            min-height: calc(100vh - var(--header-height) - var(--bottom-nav-height));
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Home Screen */
        .hero-section {
            background: var(--gradient-primary);
            border-radius: var(--border-radius-lg);
            padding: 2rem 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a" cx="50%" cy="40%" r="50%"><stop offset="0%" stop-color="%23fff" stop-opacity=".05"/><stop offset="100%" stop-color="%23fff" stop-opacity="0"/></radialGradient></defs><rect width="100" height="20" fill="url(%23a)"/></svg>');
            opacity: 0.3;
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero-title {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .hero-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Section */
        .section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0 0.25rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .view-all-btn {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .view-all-btn:hover {
            color: var(--secondary-color);
        }

        /* Categories Horizontal Scroll - Enhanced */
        .categories-container {
            margin-bottom: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        .categories-grid {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding-bottom: 0.5rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x proximity;
        }

        .categories-grid::-webkit-scrollbar {
            display: none;
        }

        .categories-grid::after {
            content: '';
            min-width: 1rem;
            flex-shrink: 0;
        }

        .category-card {
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            min-width: 100px;
            flex-shrink: 0;
            scroll-snap-align: start;
            touch-action: manipulation;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .category-card:hover::before {
            left: 100%;
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-color);
        }

        .category-card.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary-color);
        }

        .category-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 32px;
        }

        .category-name {
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1.2;
        }

        /* Channels Grid */
        .channels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .channels-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 0.75rem;
            }
        }

        .channel-card {
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            aspect-ratio: 16/9;
        }

        .channel-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .channel-card.favorite::after {
            content: '\f004';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: var(--danger-color);
            font-size: 0.875rem;
            z-index: 2;
        }

        .channel-image {
            width: 100%;
            height: 70%;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .channel-logo {
            max-width: 60%;
            max-height: 60%;
            object-fit: contain;
            border-radius: 4px;
        }

        .channel-logo-placeholder {
            width: 48px;
            height: 48px;
            background: var(--gradient-teal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .channel-info {
            padding: 0.75rem;
            height: 30%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .channel-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .channel-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .channel-category {
            background: var(--bg-secondary);
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.625rem;
            font-weight: 500;
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .status-indicator.offline {
            background: var(--text-muted);
        }

        /* Filter Bar */
        .filter-bar {
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .filter-bar.active {
            display: block;
        }

        .filter-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            min-width: 120px;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.12);
        }

        .filter-reset {
            padding: 0.5rem 1rem;
            background: var(--gradient-accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .filter-reset:hover {
            background: var(--gradient-teal);
            transform: translateY(-1px);
        }

        /* Player Screen */
        .player-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--header-height) - var(--bottom-nav-height));
            background: var(--surface);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .video-player {
            position: relative;
            background: #000;
            width: 100%;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            max-height: 70vh;
        }

        .video-element {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Quality Selector in Video Player - Enhanced */
        .video-quality-selector {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 0.5rem;
            opacity: 0;
            transition: var(--transition);
            z-index: 10;
            user-select: none;
        }

        .video-player:hover .video-quality-selector,
        .video-quality-selector.active {
            opacity: 1;
        }

        .quality-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: white;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.25rem;
            min-width: 60px;
            justify-content: space-between;
        }

        .quality-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .quality-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 0.5rem;
            min-width: 100px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quality-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .quality-option {
            padding: 0.5rem 0.75rem;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: 4px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .quality-option:last-child {
            margin-bottom: 0;
        }

        .quality-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .quality-option.active {
            background: var(--gradient-accent);
            color: white;
        }

        .quality-option i {
            font-size: 0.625rem;
            opacity: 0;
            transition: var(--transition);
        }

        .quality-option.active i {
            opacity: 1;
        }

        .video-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            padding: 2rem;
        }

        .video-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .video-controls {
            background: var(--surface);
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .video-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .video-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .video-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .video-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .video-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .video-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Mini Player */
        .mini-player {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + 1rem);
            right: 1rem;
            width: 200px;
            height: 112px;
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            z-index: var(--z-mini-player);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
        }

        .mini-player.active {
            transform: translateY(0);
            opacity: 1;
        }

        .mini-player-video {
            width: 100%;
            height: 70%;
            background: #000;
            position: relative;
        }

        .mini-player-controls {
            height: 30%;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface);
        }

        .mini-player-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            margin-right: 0.5rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .mini-player-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
            transition: var(--transition);
        }

        .mini-player-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom));
            background: var(--surface);
            background-image: linear-gradient(0deg, var(--surface) 0%, var(--bg-secondary) 100%);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            z-index: var(--z-header);
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 20px -8px rgba(26, 35, 50, 0.12);
        }

        .nav-items {
            display: flex;
            height: var(--bottom-nav-height);
            max-width: 1200px;
            margin: 0 auto;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            padding: 0.5rem 0.25rem;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--accent-color);
            border-radius: 0 0 3px 3px;
            transition: var(--transition);
        }

        .nav-item.active::before {
            width: 24px;
        }

        .nav-icon {
            font-size: 1.25rem;
            color: var(--text-muted);
            transition: var(--transition);
            margin-bottom: 0.25rem;
        }

        .nav-label {
            font-size: 0.625rem;
            font-weight: 600;
            color: var(--text-muted);
            transition: var(--transition);
        }

        .nav-item.active .nav-icon,
        .nav-item.active .nav-label {
            color: var(--accent-color);
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        /* Favorites Screen */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.875rem;
        }

        /* Settings Screen */
        .settings-section {
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .settings-header {
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item:hover {
            background: var(--bg-secondary);
        }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .settings-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-color);
        }

        .settings-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-description {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-switch.active {
            background: var(--accent-color);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        /* EPG Modal */
        .epg-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: var(--z-modal);
            display: flex;
            align-items: flex-end;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .epg-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .epg-content {
            background: var(--surface);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
            padding: 1.5rem;
            width: 100%;
            max-height: 70vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: var(--transition);
        }

        .epg-modal.active .epg-content {
            transform: translateY(0);
        }

        .epg-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .epg-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .epg-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .epg-close:hover {
            background: var(--danger-color);
            color: white;
        }

        .epg-program {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .epg-program:last-child {
            border-bottom: none;
        }

        .epg-time {
            font-size: 0.75rem;
            color: var(--accent-color);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .epg-program-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .epg-program-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: var(--z-modal);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 1rem;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: var(--transition);
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--danger-color);
            color: white;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: calc(90vh - 120px);
            overflow-y: auto;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.12);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: monospace;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn-primary {
            background: var(--gradient-accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary:hover {
            background: var(--gradient-teal);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-danger:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        /* Custom Channels List */
        .custom-channel-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .custom-channel-item:last-child {
            border-bottom: none;
        }

        .custom-channel-info {
            flex: 1;
        }

        .custom-channel-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .custom-channel-url {
            font-size: 0.75rem;
            color: var(--text-muted);
            word-break: break-all;
        }

        .custom-channel-meta {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }

        .channel-source {
            font-size: 0.625rem;
            background: var(--bg-tertiary);
            padding: 0.125rem 0.5rem;
            border-radius: 8px;
            color: var(--text-muted);
        }

        .custom-channel-actions {
            display: flex;
            gap: 0.5rem;
        }

        .custom-channel-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .custom-channel-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .custom-channel-btn.delete:hover {
            background: var(--danger-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                padding: 0;
            }
            
            .search-container {
                max-width: 200px;
                margin: 0 0.5rem;
            }
            
            .hero-title {
                font-size: 1.5rem;
            }
            
            .stats-row {
                gap: 1rem;
            }
            
            .channel-card {
                aspect-ratio: 4/3;
            }
            
            .player-container {
                border-radius: 0;
                margin: 0 -1rem;
            }
            
            .video-player {
                max-height: 60vh;
            }
            
            .mini-player {
                width: 160px;
                height: 90px;
                right: 0.5rem;
                bottom: calc(var(--bottom-nav-height) + 0.5rem);
            }

            .categories-grid {
                padding-left: 0.25rem;
                padding-right: 0.25rem;
            }

            .category-card {
                min-width: 90px;
                padding: 0.75rem 0.5rem;
            }

            .modal-content {
                margin: 0.5rem;
            }

            .modal-body {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .screen {
                padding: 0.75rem;
            }
            
            .hero-section {
                padding: 1.5rem 1rem;
            }
            
            .channel-card {
                border-radius: 8px;
            }

            .category-card {
                min-width: 80px;
                padding: 0.5rem 0.25rem;
            }

            .category-name {
                font-size: 0.625rem;
            }

            .video-quality-selector {
                top: 0.5rem;
                right: 0.5rem;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-actions button {
                width: 100%;
            }
        }

        /* Landscape Mode */
        @media (orientation: landscape) and (max-height: 600px) {
            .player-container {
                height: calc(100vh - var(--header-height));
                margin-bottom: 0;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .main-content {
                padding-bottom: 0;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .hidden { display: none !important; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }

        /* Performance Optimizations */
        .channels-grid img,
        .channel-logo {
            will-change: transform;
        }
        
        .channel-card:hover {
            will-change: transform, box-shadow;
        }
        
        .nav-item:active {
            will-change: transform;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body data-theme="light">

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <a href="#" class="logo" onclick="app.navigateTo('home')">
                    <i class="fas fa-tv"></i>
                    <span>FluxTV</span>
                </a>
                
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search channels...">
                    <i class="fas fa-search search-icon"></i>
                    <button class="search-clear" id="searchClear">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="header-actions">
                    <button class="header-btn" id="filterToggle" title="Filters">
                        <i class="fas fa-filter"></i>
                    </button>
                    <button class="header-btn" id="themeToggle" title="Toggle Dark Mode">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Home Screen -->
            <div class="screen active" id="homeScreen">
                <!-- Hero Section -->
                <section class="hero-section">
                    <div class="hero-content">
                        <h1 class="hero-title">Welcome to FluxTV</h1>
                        <p class="hero-subtitle">Premium streaming experience with thousands of live channels</p>
                        <div class="stats-row">
                            <div class="stat-item">
                                <div class="stat-number" id="totalChannelsCount">0</div>
                                <div class="stat-label">Channels</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="favoritesCount">0</div>
                                <div class="stat-label">Favorites</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="categoriesCount">0</div>
                                <div class="stat-label">Categories</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Categories -->
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Browse by Category</h2>
                        <a href="#" class="view-all-btn" onclick="app.navigateTo('search')">View All</a>
                    </div>
                    <div class="categories-container">
                        <div class="categories-grid" id="categoriesGrid">
                            <!-- Categories will be populated here -->
                        </div>
                    </div>
                </section>

                <!-- Recently Watched -->
                <section class="section" id="recentSection" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title">Recently Watched</h2>
                        <a href="#" class="view-all-btn" onclick="app.showAllRecent()">View All</a>
                    </div>
                    <div class="channels-grid" id="recentChannels">
                        <!-- Recent channels will be populated here -->
                    </div>
                </section>

                <!-- Popular Channels -->
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Popular Channels</h2>
                        <a href="#" class="view-all-btn" onclick="app.navigateTo('search')">View All</a>
                    </div>
                    <div class="channels-grid" id="popularChannels">
                        <!-- Popular channels will be populated here -->
                    </div>
                </section>
            </div>

            <!-- Search Screen -->
            <div class="screen" id="searchScreen">
                <!-- Filter Bar -->
                <div class="filter-bar" id="filterBar">
                    <div class="filter-row">
                        <select class="filter-select" id="categoryFilter">
                            <option value="">All Categories</option>
                        </select>
                        <select class="filter-select" id="languageFilter">
                            <option value="">All Languages</option>
                        </select>
                        <select class="filter-select" id="qualityFilter">
                            <option value="">All Quality</option>
                            <option value="HD">HD</option>
                            <option value="FHD">Full HD</option>
                            <option value="4K">4K</option>
                        </select>
                        <button class="filter-reset" onclick="app.resetFilters()">Reset</button>
                    </div>
                </div>

                <!-- Search Results -->
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title" id="searchTitle">All Channels</h2>
                        <span class="view-all-btn" id="searchCount">0 channels</span>
                    </div>
                    <div class="channels-grid" id="searchResults">
                        <!-- Search results will be populated here -->
                    </div>
                </section>
            </div>

            <!-- Player Screen -->
            <div class="screen" id="playerScreen">
                <div class="player-container">
                    <div class="video-player" id="videoPlayer">
                        <div class="video-placeholder" id="videoPlaceholder">
                            <i class="fas fa-play-circle"></i>
                            <h3>Select a channel to start watching</h3>
                            <p>Choose from thousands of premium live channels</p>
                        </div>
                        
                        <!-- Quality Selector -->
                        <div class="video-quality-selector" id="qualitySelector">
                            <div class="quality-toggle" onclick="app.toggleQualityDropdown()">
                                <span id="currentQuality">Auto</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="quality-dropdown" id="qualityDropdown">
                                <div class="quality-option active" onclick="app.setQuality('auto')">
                                    <span>Auto</span>
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="quality-option" onclick="app.setQuality('1080p')">
                                    <span>1080p</span>
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="quality-option" onclick="app.setQuality('720p')">
                                    <span>720p</span>
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="quality-option" onclick="app.setQuality('480p')">
                                    <span>480p</span>
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="quality-option" onclick="app.setQuality('240p')">
                                    <span>240p</span>
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="video-controls">
                        <h1 class="video-title" id="videoTitle">Select a Channel</h1>
                        <div class="video-meta">
                            <span id="videoCategory">No category</span>
                            <span></span>
                            <span id="videoStatus">Offline</span>
                            <span></span>
                            <span id="videoQuality">HD</span>
                        </div>
                        <div class="video-actions">
                            <button class="video-btn" id="favoriteBtn" onclick="app.toggleFavorite()">
                                <i class="far fa-heart"></i>
                                <span>Favorite</span>
                            </button>
                            <button class="video-btn" id="shareBtn" onclick="app.shareChannel()">
                                <i class="fas fa-share"></i>
                                <span>Share</span>
                            </button>
                            <button class="video-btn" id="epgBtn" onclick="app.showEPG()">
                                <i class="fas fa-list"></i>
                                <span>Program Guide</span>
                            </button>
                            <button class="video-btn" id="fullscreenBtn" onclick="app.toggleFullscreen()">
                                <i class="fas fa-expand"></i>
                                <span>Fullscreen</span>
                            </button>
                            <button class="video-btn" id="miniPlayerBtn" onclick="app.toggleMiniPlayer()">
                                <i class="fas fa-compress"></i>
                                <span>Mini Player</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Favorites Screen -->
            <div class="screen" id="favoritesScreen">
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">My Favorites</h2>
                        <span class="view-all-btn" id="favoritesCountText">0 channels</span>
                    </div>
                    <div class="channels-grid" id="favoritesGrid">
                        <!-- Favorites will be populated here -->
                    </div>
                    <div class="empty-state" id="favoritesEmpty">
                        <i class="far fa-heart"></i>
                        <h3>No favorites yet</h3>
                        <p>Add channels to your favorites to see them here</p>
                    </div>
                </section>
            </div>

            <!-- Settings Screen -->
            <div class="screen" id="settingsScreen">
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Settings</h2>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-header">Display & Appearance</div>
                        <div class="settings-item" onclick="app.toggleDarkMode()">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <i class="fas fa-moon"></i>
                                </div>
                                <div>
                                    <div class="settings-label">Dark Mode</div>
                                    <div class="settings-description">Switch to dark theme for better night viewing</div>
                                </div>
                            </div>
                            <div class="toggle-switch" id="darkModeToggle"></div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-header">Playback</div>
                        <div class="settings-item" onclick="app.showQualitySettings()">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <i class="fas fa-cog"></i>
                                </div>
                                <div>
                                    <div class="settings-label">Video Quality</div>
                                    <div class="settings-description">Adjust streaming quality preferences</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="app.toggleAutoplay()">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <i class="fas fa-play"></i>
                                </div>
                                <div>
                                    <div class="settings-label">Autoplay</div>
                                    <div class="settings-description">Automatically start playing when selecting channels</div>
                                </div>
                            </div>
                            <div class="toggle-switch active" id="autoplayToggle"></div>
                        </div>
                    </div>

                    
   
                   

                    <div class="settings-section">
                        <div class="settings-header">Data & Storage</div>
                        <div class="settings-item" onclick="app.clearCache()">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <i class="fas fa-trash"></i>
                                </div>
                                <div>
                                    <div class="settings-label">Clear Cache</div>
                                    <div class="settings-description">Free up storage space</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="settings-item" onclick="app.exportFavorites()">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                                <div>
                                    <div class="settings-label">Export Favorites</div>
                                    <div class="settings-description">Save your favorites list</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-header">About</div>
                        <div class="settings-item" onclick="app.showAbout()">
                            <div class="settings-item-left">
                                <div class="settings-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div>
                                    <div class="settings-label">About FluxTV</div>
                                    <div class="settings-description">Version 2.0 - Enhanced Mobile Experience</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Mini Player -->
        <div class="mini-player" id="miniPlayer">
            <div class="mini-player-video" id="miniPlayerVideo">
                <!-- Mini player video will be here -->
            </div>
            <div class="mini-player-controls">
                <div class="mini-player-title" id="miniPlayerTitle">Channel Name</div>
                <button class="mini-player-btn" onclick="app.expandMiniPlayer()" title="Expand">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="mini-player-btn" onclick="app.closeMiniPlayer()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- EPG Modal -->
        <div class="epg-modal" id="epgModal">
            <div class="epg-content">
                <div class="epg-header">
                    <h3 class="epg-title" id="epgTitle">Program Guide</h3>
                    <button class="epg-close" onclick="app.closeEPG()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="epgPrograms">
                    <!-- EPG programs will be populated here -->
                </div>
            </div>
        </div>

        <!-- Playlist Import Modal -->
        <div class="modal" id="playlistImportModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Import M3U/M3U8 Playlist</h3>
                    <button class="modal-close" onclick="app.closePlaylistImport()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label>Playlist URL</label>
                        <input type="text" id="playlistUrl" placeholder="https://example.com/playlist.m3u8">
                    </div>
                    <div class="input-group">
                        <label>Or paste M3U content</label>
                        <textarea id="playlistContent" placeholder="#EXTM3U&#10;#EXTINF:-1,Channel Name&#10;https://example.com/stream.m3u8" rows="6"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-secondary" onclick="app.closePlaylistImport()">Cancel</button>
                        <button class="btn-primary" onclick="app.importPlaylist()">Import</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Channel Modal -->
        <div class="modal" id="addChannelModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Add Single Channel</h3>
                    <button class="modal-close" onclick="app.closeAddChannel()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label>Channel Name</label>
                        <input type="text" id="channelName" placeholder="Enter channel name">
                    </div>
                    <div class="input-group">
                        <label>Stream URL</label>
                        <input type="text" id="channelUrl" placeholder="https://example.com/stream.m3u8">
                    </div>
                    <div class="input-group">
                        <label>Category</label>
                        <input type="text" id="channelCategory" placeholder="Enter category (e.g., Entertainment)">
                    </div>
                    <div class="input-group">
                        <label>Logo URL (Optional)</label>
                        <input type="text" id="channelLogo" placeholder="https://example.com/logo.png">
                    </div>
                    <div class="modal-actions">
                        <button class="btn-secondary" onclick="app.closeAddChannel()">Cancel</button>
                        <button class="btn-primary" onclick="app.addCustomChannel()">Add Channel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Channels Modal -->
        <div class="modal" id="customChannelsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Custom Channels</h3>
                    <button class="modal-close" onclick="app.closeCustomChannels()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="customChannelsList">
                        <!-- Custom channels will be listed here -->
                    </div>
                    <div class="modal-actions">
                        <button class="btn-secondary" onclick="app.exportCustomChannels()">Export</button>
                        <button class="btn-danger" onclick="app.clearCustomChannels()">Clear All</button>
                        <button class="btn-primary" onclick="app.closeCustomChannels()">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Predefined Playlists Modal -->
        <div class="modal" id="predefinedPlaylistsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Predefined Playlists</h3>
                    <button class="modal-close" onclick="app.closePredefinedPlaylists()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="predefinedPlaylistsList">
                        <!-- Predefined playlists will be listed here -->
                    </div>
                    <div class="modal-actions mt-3">
                        <button class="btn-primary" onclick="app.closePredefinedPlaylists()">Done</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-items">
                <div class="nav-item active" onclick="app.navigateTo('home')" data-screen="home">
                    <i class="fas fa-home nav-icon"></i>
                    <span class="nav-label">Home</span>
                </div>
                <div class="nav-item" onclick="app.navigateTo('search')" data-screen="search">
                    <i class="fas fa-search nav-icon"></i>
                    <span class="nav-label">Search</span>
                </div>
                <div class="nav-item" onclick="app.navigateTo('player')" data-screen="player">
                    <i class="fas fa-play nav-icon"></i>
                    <span class="nav-label">Player</span>
                </div>
                <div class="nav-item" onclick="app.navigateTo('favorites')" data-screen="favorites">
                    <i class="fas fa-heart nav-icon"></i>
                    <span class="nav-label">Favorites</span>
                </div>
                <div class="nav-item" onclick="app.navigateTo('settings')" data-screen="settings">
                    <i class="fas fa-cog nav-icon"></i>
                    <span class="nav-label">Settings</span>
                </div>
            </div>
        </nav>
    </div>

    <script>
        // --- Firebase Config & Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyBk0Uza5A6iBI8UraHou6UaDFHj9X3LY5E",
            authDomain: "smartmovie-304e3.firebaseapp.com",
            databaseURL: "https://smartmovie-304e3-default-rtdb.firebaseio.com",
            projectId: "smartmovie-304e3",
            storageBucket: "smartmovie-304e3.firebasestorage.app",
            messagingSenderId: "825949220215",
            appId: "1:825949220215:web:fc9a59604fef56df610572"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        class LiveTVMobileApp {
            constructor() {
                this.channels = [];
                this.customChannels = [];
                this.allChannels = [];
                this.filteredChannels = [];
                this.currentChannel = null;
                this.favorites = this.loadFromStorage('favorites', []);
                this.recentChannels = this.loadFromStorage('recentChannels', []);
                this.currentScreen = 'home';
                this.hls = null;
                this.miniPlayerActive = false;
                this.editingChannelId = null;
                this.settings = this.loadFromStorage('settings', {
                    darkMode: false,
                    autoplay: true,
                    quality: 'auto'
                });
                this.providers = [
                    {
                        "title": "Sony Liv",
                        "logo": "https://raw.githubusercontent.com/kunwarxshashank/rogplay_addons/refs/heads/main/assets/sonyliv.jpg",
                        "url": "https://raw.githubusercontent.com/kunwarxshashank/rogplay_addons/refs/heads/main/livetv/data/sonyliv.m3u",
                        "type": "livetv",
                        "version": "1.0",
                        "description": "Watch All Live Tv Channels of Sony Liv"
                    },
                    {
                        "title": "Jio TV",
                        "logo": "https://raw.githubusercontent.com/kunwarxshashank/rogplay_addons/refs/heads/main/assets/jiotv.jpg", 
                        "url": "https://m3u.ibert.workers.dev/m3u/jiotvplus.m3u",
                        "type": "livetv",
                        "version": "1.0",
                        "description": "800+ Indian TV Channels from JIOTV"
                    },
                    {
                        "title": "Jio Cinema",
                        "logo": "https://static.wikia.nocookie.net/logopedia/images/8/8e/JioCinema.png/revision/latest?cb=20200422113209",
                        "url": "https://m3u.ibert.workers.dev/m3u/jiocinema.m3u",
                        "type": "livetv",
                        "version": "1.0",
                        "description": "Jiocinema Live TV"
                    },
                    {
                        "title": "Fancode",
                        "logo": "https://upload.wikimedia.org/wikipedia/en/thumb/6/6c/FanCode_logo.svg/1200px-FanCode_logo.svg.png",
                        "url": "https://raw.githubusercontent.com/drmlive/fancode-live-events/refs/heads/main/fancode.m3u",
                        "type": "livetv",
                        "version": "1.0",
                        "description": "Fancode Live Events"
                    },
                    {
                        "title": "Zee 5",
                        "logo": "https://yt3.googleusercontent.com/ytc/AIdro_nO4wJmh7M9ktKbzNomqW4ais4W3Y69b4RngbQnagV08T8=s900-c-k-c0x00ffffff-no-rj",
                        "url": "https://raw.githubusercontent.com/alex4528/m3u/refs/heads/main/z5.m3u",
                        "type": "livetv",
                        "version": "1.0",
                        "description": "Zee5 Live TV"
                    },
                    {
                        "title": "Dish TV",
                        "logo": "https://raw.githubusercontent.com/kunwarxshashank/rogplay_addons/refs/heads/main/assets/dishtv.webp",
                        "url": "https://m3u.ibert.workers.dev/m3u/dishtv.m3u",
                        "type": "livetv",
                        "version": "1.0",
                        "description": "HD Channels From Dishtv"
                    },
                    {
                        "title": "Shoq TV",
                        "logo": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQlrlWLa46kZ6A-l4m9SOOZSpZ3UGRi7s-LEQ&s",
                        "url": "https://raw.githubusercontent.com/alex4528/m3u/refs/heads/main/shoq.m3u",
                        "type": "livetv",
                        "version": "1.0",
                        "description": "Pakistani TV Channels"
                    },
                    {
                        "title": "Dangal Play",
                        "logo": "https://play-lh.googleusercontent.com/q61rvDyY64hAXqnx-Tk6m1sY_t3R9efheeIy0P8q_b1khx4DgcplDW-WsmqBpthDZg",
                        "url": "https://raw.githubusercontent.com/kunwarxshashank/rogplay_addons/refs/heads/main/livetv/data/dangalplay.m3u",
                        "type": "livetv",
                        "version": "1.0",
                        "description": "HD Channels From Dangal Play"
                    },
                    {
                        "title": "YuppTV",
                        "logo": "https://raw.githubusercontent.com/kunwarxshashank/rogplay_addons/refs/heads/main/assets/yupptv.jpg",
                        "url": "https://raw.githubusercontent.com/kunwarxshashank/rogplay_addons/refs/heads/main/livetv/data/yupptv.m3u",
                        "type": "livetv",
                        "version": "1.0",
                        "description": "Free Channels available of YuppTV"
                    },
                    {
                        "title": "Mxplayer TV",
                        "logo": "https://raw.githubusercontent.com/kunwarxshashank/rogplay_addons/refs/heads/main/assets/mxplayer.png",
                        "url": "https://raw.githubusercontent.com/kunwarxshashank/rogplay_addons/refs/heads/main/livetv/data/mxplay.m3u",
                        "type": "livetv",
                        "version": "1.0",
                        "description": "Free Channels available on MX Player"
                    }
                ];
                
                this.init();
            }

            async init() {
                this.bindEvents();
                this.applyTheme();
                this.updateUI();
                await this.loadChannels();
                this.loadCustomChannels();
                this.updateChannelsList();
                // Loading screen removed completely
            }

            bindEvents() {
                // Search functionality
                const searchInput = document.getElementById('searchInput');
                const searchClear = document.getElementById('searchClear');
                
                searchInput.addEventListener('input', (e) => {
                    this.performSearch(e.target.value);
                    searchClear.classList.toggle('show', e.target.value.length > 0);
                });
                
                searchClear.addEventListener('click', () => {
                    searchInput.value = '';
                    searchClear.classList.remove('show');
                    this.performSearch('');
                });

                // Filter toggle
                document.getElementById('filterToggle').addEventListener('click', () => {
                    this.toggleFilterBar();
                });

                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleDarkMode();
                });

                // Filter selects
                ['categoryFilter', 'languageFilter', 'qualityFilter'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        this.applyFilters();
                    });
                });

                // Close modals when clicking outside
                document.getElementById('epgModal').addEventListener('click', (e) => {
                    if (e.target.id === 'epgModal') {
                        this.closeEPG();
                    }
                });

                document.getElementById('playlistImportModal').addEventListener('click', (e) => {
                    if (e.target.id === 'playlistImportModal') {
                        this.closePlaylistImport();
                    }
                });

                document.getElementById('addChannelModal').addEventListener('click', (e) => {
                    if (e.target.id === 'addChannelModal') {
                        this.closeAddChannel();
                    }
                });

                document.getElementById('customChannelsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'customChannelsModal') {
                        this.closeCustomChannels();
                    }
                });

                document.getElementById('predefinedPlaylistsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'predefinedPlaylistsModal') {
                        this.closePredefinedPlaylists();
                    }
                });

                // Close quality dropdown when clicking video player
                document.getElementById('videoPlayer').addEventListener('click', (e) => {
                    const qualitySelector = document.getElementById('qualitySelector');
                    if (!qualitySelector.contains(e.target)) {
                        document.getElementById('qualityDropdown').classList.remove('active');
                        qualitySelector.classList.remove('active');
                    }
                });

                // Categories horizontal scroll with touch support
                this.initializeCategoriesScroll();

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    this.handleKeyboard(e);
                });

                // Orientation change
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.handleOrientationChange(), 100);
                });

                // Fullscreen change events for cross-browser compatibility
                document.addEventListener('fullscreenchange', () => this.handleFullscreenChange());
                document.addEventListener('webkitfullscreenchange', () => this.handleFullscreenChange());
                document.addEventListener('mozfullscreenchange', () => this.handleFullscreenChange());
                document.addEventListener('MSFullscreenChange', () => this.handleFullscreenChange());

                // Prevent zoom on double tap
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (e) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }

            initializeCategoriesScroll() {
                const categoriesGrid = document.getElementById('categoriesGrid');
                let isScrolling = false;
                let startX = 0;
                let scrollLeft = 0;
                let velocity = 0;
                let lastX = 0;
                let lastTime = 0;
                let animationId = null;

                // Enhanced touch start
                categoriesGrid.addEventListener('touchstart', (e) => {
                    isScrolling = true;
                    startX = e.touches[0].pageX - categoriesGrid.offsetLeft;
                    scrollLeft = categoriesGrid.scrollLeft;
                    lastX = e.touches[0].pageX;
                    lastTime = Date.now();
                    velocity = 0;
                    
                    // Cancel any ongoing momentum animation
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                }, { passive: true });

                // Enhanced touch move with velocity tracking
                categoriesGrid.addEventListener('touchmove', (e) => {
                    if (!isScrolling) return;
                    e.preventDefault();
                    
                    const currentX = e.touches[0].pageX;
                    const currentTime = Date.now();
                    const deltaX = currentX - lastX;
                    const deltaTime = currentTime - lastTime;
                    
                    // Calculate velocity for momentum
                    if (deltaTime > 0) {
                        velocity = deltaX / deltaTime;
                    }
                    
                    const x = currentX - categoriesGrid.offsetLeft;
                    const walk = (x - startX) * 1.5; // Slightly increased sensitivity
                    categoriesGrid.scrollLeft = scrollLeft - walk;
                    
                    lastX = currentX;
                    lastTime = currentTime;
                }, { passive: false });

                // Enhanced touch end with momentum scrolling
                categoriesGrid.addEventListener('touchend', () => {
                    isScrolling = false;
                    
                    // Apply momentum scrolling if velocity is significant
                    if (Math.abs(velocity) > 0.5) {
                        startMomentumScroll(categoriesGrid, velocity);
                    }
                }, { passive: true });

                // Momentum scrolling function
                function startMomentumScroll(element, initialVelocity) {
                    let currentVelocity = initialVelocity * 100; // Scale velocity
                    const friction = 0.95; // Friction coefficient
                    const minVelocity = 0.1; // Minimum velocity to continue

                    function animate() {
                        if (Math.abs(currentVelocity) > minVelocity) {
                            element.scrollLeft -= currentVelocity;
                            currentVelocity *= friction;
                            animationId = requestAnimationFrame(animate);
                        } else {
                            animationId = null;
                        }
                    }
                    
                    animationId = requestAnimationFrame(animate);
                }

                // Mouse support for desktop testing
                let isMouseDown = false;
                
                categoriesGrid.addEventListener('mousedown', (e) => {
                    isMouseDown = true;
                    startX = e.pageX - categoriesGrid.offsetLeft;
                    scrollLeft = categoriesGrid.scrollLeft;
                    categoriesGrid.style.cursor = 'grabbing';
                });

                categoriesGrid.addEventListener('mouseleave', () => {
                    isMouseDown = false;
                    categoriesGrid.style.cursor = 'grab';
                });

                categoriesGrid.addEventListener('mouseup', () => {
                    isMouseDown = false;
                    categoriesGrid.style.cursor = 'grab';
                });

                categoriesGrid.addEventListener('mousemove', (e) => {
                    if (!isMouseDown) return;
                    e.preventDefault();
                    const x = e.pageX - categoriesGrid.offsetLeft;
                    const walk = (x - startX) * 2;
                    categoriesGrid.scrollLeft = scrollLeft - walk;
                });

                // Set initial cursor style
                categoriesGrid.style.cursor = 'grab';
            }

            // ===== FIREBASE DATA LOADING (MODIFIED FOR ADMIN PANEL COMPATIBILITY) =====
            async loadChannels() {
                try {
                    await this.loadChannelsFromFirebase();
                } catch (error) {
                    console.error('Failed to load channels from Firebase:', error);
                }
            }

            async loadChannelsFromFirebase() {
                return new Promise((resolve, reject) => {
                    // Update: Reading from 'channels' node where Admin Panel pushes data
                    const dbRef = database.ref('channels'); 
                    dbRef.once('value')
                        .then((snapshot) => {
                            const data = snapshot.val();
                            this.channels = [];

                            if (data) {
                                // Admin panel uses Firebase push(), so data is an object with unique keys (IDs)
                                const rawData = [];
                                Object.keys(data).forEach(key => {
                                    rawData.push({
                                        id: key,
                                        ...data[key]
                                    });
                                });

                                this.channels = rawData.map((item) => {
                                    // Map Admin Panel field names to FluxTV internal field names
                                    return {
                                        id: item.id,
                                        name: item.name || 'Unknown Channel',
                                        // Admin Panel saves as 'iconUrl', app expects 'logo'
                                        logo: item.iconUrl || item.logo || item.icon || '',
                                        // Admin Panel saves as 'category', app expects 'group' (or match existing)
                                        group: item.category || item.group || 'Uncategorized',
                                        // Admin Panel saves as 'streamUrl', app expects 'url'
                                        url: item.streamUrl || item.url || '',
                                        tvgId: item.tvgId || ''
                                    };
                                }).filter(ch => ch.url); // Ensure URL exists
                            }

                            this.filteredChannels = [...this.channels];
                            this.updateUI();
                            console.log(`Loaded ${this.channels.length} channels from Firebase successfully!`);
                            resolve();
                        })
                        .catch((error) => {
                            reject(error);
                        });
                });
            }
            // ===== END FIREBASE DATA LOADING =====

            // ===== CUSTOM CHANNELS MANAGEMENT =====
            loadCustomChannels() {
                this.customChannels = this.loadFromStorage('customChannels', []);
            }

            updateChannelsList() {
                // Combine default channels with custom channels
                this.allChannels = [...this.channels, ...this.customChannels];
                this.filteredChannels = [...this.allChannels];
                
                // Update UI if we're on a screen that shows channels
                if (this.currentScreen === 'home' || this.currentScreen === 'search') {
                    this.updateUI();
                }
            }

            // Playlist Import Functions
            showPlaylistImport() {
                document.getElementById('playlistImportModal').classList.add('active');
            }

            closePlaylistImport() {
                document.getElementById('playlistImportModal').classList.remove('active');
                document.getElementById('playlistUrl').value = '';
                document.getElementById('playlistContent').value = '';
            }

            // Kept primarily for the manual import logic
            parseExtinf(line) {
                const channel = {
                    name: '',
                    logo: '',
                    group: 'Uncategorized',
                    tvgId: '',
                    url: ''
                };

                const tvgIdMatch = line.match(/tvg-id="([^"]*)"/);
                const tvgLogoMatch = line.match(/tvg-logo="([^"]*)"/);
                const groupTitleMatch = line.match(/group-title="([^"]*)"/);
                
                if (tvgIdMatch) channel.tvgId = tvgIdMatch[1];
                if (tvgLogoMatch) channel.logo = tvgLogoMatch[1];
                if (groupTitleMatch) channel.group = groupTitleMatch[1];

                const nameMatch = line.match(/,(.*)$/);
                if (nameMatch) {
                    channel.name = nameMatch[1].trim();
                }

                return channel;
            }

            async fetchWithHeaders(url) {
                // Simplified fetch for manual imports
                let headers = {};
                const response = await fetch(url, { 
                    method: 'GET',
                    headers: headers,
                    mode: 'cors'
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.text();
            }

            async importPlaylist() {
                const url = document.getElementById('playlistUrl').value.trim();
                const content = document.getElementById('playlistContent').value.trim();
                
                if (!url && !content) {
                    alert('Please enter a playlist URL or paste M3U content');
                    return;
                }
                
                try {
                    let m3uContent = content;
                    
                    if (url) {
                        // For manual imports, use CORS Proxy if needed
                        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                        m3uContent = await this.fetchWithHeaders(proxyUrl);
                    }
                    
                    if (!m3uContent.includes('#EXTM3U')) {
                        throw new Error('Invalid M3U playlist format');
                    }
                    
                    // Parse and add channels to custom channels
                    this.parseAndAddChannels(m3uContent, 'manual');
                    this.closePlaylistImport();
                    alert(`Successfully imported playlist! Added ${this.getLastImportCount()} channels.`);
                    
                } catch (error) {
                    console.error('Playlist import failed:', error);
                    alert('Failed to import playlist: ' + error.message);
                }
            }

            // This method is for adding channels to the `customChannels` array
            parseAndAddChannels(m3uContent, sourceTitle = 'manual') {
                const customChannels = this.loadFromStorage('customChannels', []);
                const lines = m3uContent.split('\n').map(line => line.trim()).filter(line => line);
                
                let currentChannel = null;
                let importedCount = 0;
                
                for (const line of lines) {
                    if (line.startsWith('#EXTINF:')) {
                        currentChannel = this.parseExtinf(line);
                    } else if (line && !line.startsWith('#') && currentChannel) {
                        currentChannel.url = line;
                        currentChannel.id = this.generateId();
                        currentChannel.isCustom = true; // Mark as custom
                        currentChannel.source = sourceTitle; // Add source property
                        
                        // Check if channel already exists to prevent duplicates
                        const exists = customChannels.some(ch => 
                            ch.name === currentChannel.name && ch.url === currentChannel.url
                        );
                        
                        if (!exists) {
                            customChannels.push(currentChannel);
                            importedCount++;
                        }
                        
                        currentChannel = null;
                    }
                }
                
                this.saveToStorage('customChannels', customChannels);
                this.lastImportCount = importedCount;
                this.loadCustomChannels();
                this.updateChannelsList();
            }

            getLastImportCount() {
                return this.lastImportCount || 0;
            }

            // Single Channel Functions
            showAddChannel() {
                document.getElementById('addChannelModal').classList.add('active');
            }

            closeAddChannel() {
                document.getElementById('addChannelModal').classList.remove('active');
                document.getElementById('channelName').value = '';
                document.getElementById('channelUrl').value = '';
                document.getElementById('channelCategory').value = '';
                document.getElementById('channelLogo').value = '';
                this.editingChannelId = null;
                
                // Reset button text
                const addButton = document.querySelector('#addChannelModal .btn-primary');
                addButton.textContent = 'Add Channel';
                addButton.onclick = () => this.addCustomChannel();
            }

            addCustomChannel() {
                const name = document.getElementById('channelName').value.trim();
                const url = document.getElementById('channelUrl').value.trim();
                const category = document.getElementById('channelCategory').value.trim() || 'Custom';
                const logo = document.getElementById('channelLogo').value.trim();
                
                if (!name || !url) {
                    alert('Please enter channel name and URL');
                    return;
                }
                
                if (!url.includes('://')) {
                    alert('Please enter a valid URL starting with http:// or https://');
                    return;
                }
                
                const customChannels = this.loadFromStorage('customChannels', []);
                
                // Check if channel already exists
                const exists = customChannels.some(ch => 
                    ch.name === name && ch.url === url
                );
                
                if (exists) {
                    alert('This channel already exists in your custom channels');
                    return;
                }
                
                const newChannel = {
                    id: this.generateId(),
                    name: name,
                    url: url,
                    group: category,
                    logo: logo || this.getDefaultLogo(),
                    isCustom: true,
                    source: 'manual'
                };
                
                customChannels.push(newChannel);
                this.saveToStorage('customChannels', customChannels);
                this.closeAddChannel();
                this.loadCustomChannels();
                this.updateChannelsList();
                
                alert('Channel added successfully!');
            }

            // Custom Channels Management
            manageCustomChannels() {
                this.showCustomChannels();
            }

            showCustomChannels() {
                const modal = document.getElementById('customChannelsModal');
                const channelsList = document.getElementById('customChannelsList');
                
                const customChannels = this.loadFromStorage('customChannels', []);
                
                if (customChannels.length === 0) {
                    channelsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-tv"></i>
                            <h3>No custom channels</h3>
                            <p>Add channels using the import or add channel features</p>
                        </div>
                    `;
                } else {
                    channelsList.innerHTML = customChannels.map(channel => `
                        <div class="custom-channel-item">
                            <div class="custom-channel-info">
                                <div class="custom-channel-name">${this.escapeHtml(channel.name)}</div>
                                <div class="custom-channel-url">${this.escapeHtml(channel.url)}</div>
                                <div class="custom-channel-meta">
                                    <span class="channel-category">${this.escapeHtml(channel.group)}</span>
                                    <span class="channel-source">${this.escapeHtml(channel.source || 'manual')}</span>
                                </div>
                            </div>
                            <div class="custom-channel-actions">
                                <button class="custom-channel-btn" onclick="app.playCustomChannel('${channel.id}')" title="Play">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="custom-channel-btn" onclick="app.editCustomChannel('${channel.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="custom-channel-btn delete" onclick="app.deleteCustomChannel('${channel.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
                
                modal.classList.add('active');
            }

            closeCustomChannels() {
                document.getElementById('customChannelsModal').classList.remove('active');
            }

            playCustomChannel(channelId) {
                const customChannels = this.loadFromStorage('customChannels', []);
                const channel = customChannels.find(ch => ch.id === channelId);
                
                if (channel) {
                    this.playChannel(channel.id); // Pass the original ID, not the custom one if it's the same
                    this.closeCustomChannels();
                }
            }

            editCustomChannel(channelId) {
                const customChannels = this.loadFromStorage('customChannels', []);
                const channel = customChannels.find(ch => ch.id === channelId);
                
                if (channel) {
                    document.getElementById('channelName').value = channel.name;
                    document.getElementById('channelUrl').value = channel.url;
                    document.getElementById('channelCategory').value = channel.group;
                    document.getElementById('channelLogo').value = channel.logo || '';
                    
                    // Store the channel ID for update
                    this.editingChannelId = channelId;
                    
                    this.closeCustomChannels();
                    this.showAddChannel();
                    
                    // Change button text to "Update"
                    const addButton = document.querySelector('#addChannelModal .btn-primary');
                    addButton.textContent = 'Update Channel';
                    addButton.onclick = () => this.updateCustomChannel();
                }
            }

            updateCustomChannel() {
                const customChannels = this.loadFromStorage('customChannels', []);
                const channelIndex = customChannels.findIndex(ch => ch.id === this.editingChannelId);
                
                if (channelIndex === -1) {
                    alert('Channel not found');
                    return;
                }
                
                const name = document.getElementById('channelName').value.trim();
                const url = document.getElementById('channelUrl').value.trim();
                const category = document.getElementById('channelCategory').value.trim() || 'Custom';
                const logo = document.getElementById('channelLogo').value.trim();
                
                if (!name || !url) {
                    alert('Please enter channel name and URL');
                    return;
                }
                
                customChannels[channelIndex] = {
                    ...customChannels[channelIndex],
                    name: name,
                    url: url,
                    group: category,
                    logo: logo || this.getDefaultLogo()
                };
                
                this.saveToStorage('customChannels', customChannels);
                this.closeAddChannel();
                this.loadCustomChannels();
                this.updateChannelsList();
                
                // Reset editing state
                this.editingChannelId = null;
                
                alert('Channel updated successfully!');
            }

            deleteCustomChannel(channelId) {
                if (!confirm('Are you sure you want to delete this channel?')) {
                    return;
                }
                
                const customChannels = this.loadFromStorage('customChannels', []);
                const updatedChannels = customChannels.filter(ch => ch.id !== channelId);
                
                this.saveToStorage('customChannels', updatedChannels);
                this.loadCustomChannels();
                this.updateChannelsList();
                this.showCustomChannels(); // Refresh the list
            }

            clearCustomChannels() {
                if (!confirm('Are you sure you want to delete all custom channels? This action cannot be undone.')) {
                    return;
                }
                
                this.saveToStorage('customChannels', []);
                this.loadCustomChannels();
                this.updateChannelsList();
                this.showCustomChannels(); // Refresh the list
                alert('All custom channels have been deleted.');
            }

            exportCustomChannels() {
                const customChannels = this.loadFromStorage('customChannels', []);
                
                if (customChannels.length === 0) {
                    alert('No custom channels to export');
                    return;
                }
                
                const exportData = {
                    exportDate: new Date().toISOString(),
                    version: '2.0',
                    type: 'custom_channels',
                    channels: customChannels
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `livetv_custom_channels_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            // Predefined Playlists
            showPredefinedPlaylists() {
                const modal = document.getElementById('predefinedPlaylistsModal');
                const list = document.getElementById('predefinedPlaylistsList');
                
                list.innerHTML = this.providers.map(provider => `
                    <div class="custom-channel-item">
                        <div class="custom-channel-info">
                            <div class="custom-channel-name" style="display: flex; align-items: center; gap: 0.75rem;">
                                ${provider.logo ? `<img src="${this.escapeHtml(provider.logo)}" alt="${this.escapeHtml(provider.title)} logo" style="width: 32px; height: 32px; border-radius: 6px; object-fit: contain;">` : '<i class="fas fa-tv" style="font-size: 1.5rem; width: 32px; text-align: center;"></i>'}
                                <span>${this.escapeHtml(provider.title)}</span>
                            </div>
                            <div class="custom-channel-url">${this.escapeHtml(provider.description)}</div>
                            <div class="custom-channel-meta">
                                <span class="channel-category">${this.escapeHtml(provider.type)}</span>
                                <span class="channel-source">v${this.escapeHtml(provider.version)}</span>
                            </div>
                        </div>
                        <div class="custom-channel-actions">
                            <button class="custom-channel-btn" onclick="app.importPredefinedPlaylist('${this.escapeHtml(provider.url)}', '${this.escapeHtml(provider.title)}')" title="Import">
                                <i class="fas fa-file-import"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                modal.classList.add('active');
            }

            closePredefinedPlaylists() {
                document.getElementById('predefinedPlaylistsModal').classList.remove('active');
            }

            async importPredefinedPlaylist(url, title) {
                if (!confirm(`Are you sure you want to import channels from ${title}? This will add them to your custom channels.`)) {
                    return;
                }

                try {
                    // List of proxy methods for predefined playlists
                    const methods = [
                        { name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url) },
                        { name: 'CORS Proxy.io', url: 'https://corsproxy.io/?' + encodeURIComponent(url) },
                        { name: 'AllOrigins', url: 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url) },
                        { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' + encodeURIComponent(url) }, // Added ThingProxy
                        { name: 'Direct', url: url }
                    ];

                    let success = false;
                    let m3uContent = '';

                    for (const method of methods) {
                        try {
                            console.log(`Attempting to import from ${title} via ${method.name}: ${method.url}`);
                            m3uContent = await this.fetchWithHeaders(method.url);
                            if (m3uContent && m3uContent.includes('#EXTM3U')) {
                                success = true;
                                console.log(`Successfully fetched playlist from ${title} via ${method.name}!`);
                                break;
                            }
                        } catch (error) {
                            console.log(`${method.name} failed for ${title}:`, error.message);
                        }
                    }

                    if (!success) {
                        throw new Error('Unable to fetch playlist content. Please try again or use direct import.');
                    }
                    
                    this.parseAndAddChannels(m3uContent, title); // Pass title as source for custom channels
                    alert(`Successfully imported channels from ${title}! Added ${this.getLastImportCount()} channels.`);
                    this.showCustomChannels(); // Refresh custom channels list after import
                } catch (error) {
                    console.error(`Failed to import playlist from ${title}:`, error);
                    alert(`Failed to import playlist from ${title}: ${error.message}`);
                }
            }


            // Navigation
            navigateTo(screen) {
                // Update active screen
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                
                document.getElementById(`${screen}Screen`).classList.add('active');
                document.querySelector(`[data-screen="${screen}"]`).classList.add('active');
                
                this.currentScreen = screen;
                
                // Update screen-specific content
                this.updateScreenContent(screen);
            }

            updateScreenContent(screen) {
                switch (screen) {
                    case 'home':
                        this.updateHomeScreen();
                        break;
                    case 'search':
                        this.updateSearchScreen();
                        break;
                    case 'favorites':
                        this.updateFavoritesScreen();
                        break;
                    case 'settings':
                        this.updateSettingsScreen();
                        break;
                }
            }

            // Screen Updates
            updateHomeScreen() {
                this.updateStats();
                this.updateCategories();
                this.updateRecentChannels();
                this.updatePopularChannels();
            }

            updateSearchScreen() {
                this.updateFilterOptions();
                this.updateSearchResults();
            }

            updateFavoritesScreen() {
                const favoritesGrid = document.getElementById('favoritesGrid');
                const favoritesEmpty = document.getElementById('favoritesEmpty');
                const favoritesCountText = document.getElementById('favoritesCountText');
                
                favoritesCountText.textContent = `${this.favorites.length} channels`;
                
                if (this.favorites.length === 0) {
                    favoritesGrid.innerHTML = '';
                    favoritesEmpty.style.display = 'block';
                } else {
                    favoritesEmpty.style.display = 'none';
                    const favoriteChannels = this.allChannels.filter(ch => this.favorites.includes(ch.id));
                    favoritesGrid.innerHTML = favoriteChannels.map(channel => this.createChannelCard(channel)).join('');
                }
            }

            updateSettingsScreen() {
                const darkModeToggle = document.getElementById('darkModeToggle');
                const autoplayToggle = document.getElementById('autoplayToggle');
                
                darkModeToggle.classList.toggle('active', this.settings.darkMode);
                autoplayToggle.classList.toggle('active', this.settings.autoplay);
                
                // Update quality display
                document.getElementById('currentQuality').textContent = 
                    this.settings.quality === 'auto' ? 'Auto' : this.settings.quality;
                    
                // Update quality dropdown selection
                document.querySelectorAll('.quality-option').forEach(option => {
                    option.classList.remove('active');
                    const qualityText = option.querySelector('span').textContent.toLowerCase();
                    if ((this.settings.quality === 'auto' && qualityText === 'auto') || 
                        qualityText === this.settings.quality) {
                        option.classList.add('active');
                    }
                });
            }

            updateStats() {
                document.getElementById('totalChannelsCount').textContent = this.allChannels.length;
                document.getElementById('favoritesCount').textContent = this.favorites.length;
                
                const categories = [...new Set(this.allChannels.map(ch => ch.group))];
                document.getElementById('categoriesCount').textContent = categories.length;
            }

            updateCategories() {
                const categoriesGrid = document.getElementById('categoriesGrid');
                const categories = [...new Set(this.allChannels.map(ch => ch.group))].sort();
                
                categoriesGrid.innerHTML = categories.map(category => `
                    <div class="category-card" onclick="app.filterByCategory('${category}')">
                        <div class="category-icon">
                            ${this.getCategoryIcon(category)}
                        </div>
                        <div class="category-name">${category}</div>
                    </div>
                `).join('');
            }

            updateRecentChannels() {
                const recentSection = document.getElementById('recentSection');
                const recentChannels = document.getElementById('recentChannels');
                
                if (this.recentChannels.length === 0) {
                    recentSection.style.display = 'none';
                    return;
                }
                
                recentSection.style.display = 'block';
                const recentChannelData = this.recentChannels.map(id => 
                    this.allChannels.find(ch => ch.id === id)
                ).filter(ch => ch).slice(0, 6);
                
                recentChannels.innerHTML = recentChannelData.map(channel => this.createChannelCard(channel)).join('');
            }

            updatePopularChannels() {
                const popularChannels = document.getElementById('popularChannels');
                const popularChannelData = this.allChannels.slice(0, 6);
                
                popularChannels.innerHTML = popularChannelData.map(channel => this.createChannelCard(channel)).join('');
            }

            updateFilterOptions() {
                const categoryFilter = document.getElementById('categoryFilter');
                const languageFilter = document.getElementById('languageFilter');
                
                // Update category options
                const categories = [...new Set(this.allChannels.map(ch => ch.group))].sort();
                categoryFilter.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                
                // Update language options (extracted from channel names)
                const languages = [...new Set(this.allChannels.map(ch => this.extractLanguage(ch.name)))].filter(Boolean).sort();
                languageFilter.innerHTML = '<option value="">All Languages</option>' +
                    languages.map(lang => `<option value="${lang}">${lang}</option>`).join('');
            }

            updateSearchResults() {
                const searchResults = document.getElementById('searchResults');
                const searchCount = document.getElementById('searchCount');
                const searchTitle = document.getElementById('searchTitle');
                
                searchCount.textContent = `${this.filteredChannels.length} channels`;
                
                if (this.filteredChannels.length === 0) {
                    searchResults.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="fas fa-search"></i>
                            <h3>No channels found</h3>
                            <p>Try adjusting your search or filters</p>
                        </div>
                    `;
                } else {
                    searchResults.innerHTML = this.filteredChannels.map(channel => this.createChannelCard(channel)).join('');
                }
            }

            // Channel Management
            createChannelCard(channel) {
                const isFavorite = this.favorites.includes(channel.id);
                const logoSrc = channel.logo || this.getDefaultLogo();
                const isCustom = channel.isCustom || false; // Check if it's a custom-added channel
                
                return `
                    <div class="channel-card ${isFavorite ? 'favorite' : ''} ${isCustom ? 'custom' : ''}" onclick="app.playChannel('${channel.id}')">
                        <div class="channel-image">
                            <img class="channel-logo" src="${logoSrc}" alt="${this.escapeHtml(channel.name)}" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="channel-logo-placeholder" style="display: none;">
                                <i class="fas fa-tv"></i>
                            </div>
                            ${isCustom ? `<div class="channel-category" style="position: absolute; top: 0.5rem; left: 0.5rem; background: var(--accent-color); color: white;">${this.escapeHtml(channel.source || 'Custom')}</div>` : ''}
                        </div>
                        <div class="channel-info">
                            <div class="channel-name">${this.escapeHtml(channel.name)}</div>
                            <div class="channel-meta">
                                <span class="channel-category">${this.escapeHtml(channel.group)}</span>
                                <div class="status-indicator"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            async playChannel(channelId) {
                const channel = this.allChannels.find(ch => ch.id === channelId);
                if (!channel) return;

                this.currentChannel = channel;
                this.addToRecent(channelId);
                
                // Navigate to player if not already there
                if (this.currentScreen !== 'player') {
                    this.navigateTo('player');
                }
                
                this.updatePlayerUI();
                
                if (this.settings.autoplay) {
                    await this.startPlayback();
                }
            }

            async startPlayback() {
                if (!this.currentChannel) return;

                const videoPlayer = document.getElementById('videoPlayer');
                const videoPlaceholder = document.getElementById('videoPlaceholder');
                
                try {
                    // Clear existing video
                    const existingVideo = videoPlayer.querySelector('video');
                    if (existingVideo) {
                        existingVideo.remove();
                    }
                    
                    // Hide placeholder
                    videoPlaceholder.style.display = 'none';
                    
                    // Create video element
                    const video = document.createElement('video');
                    video.className = 'video-element';
                    video.controls = true;
                    video.autoplay = true;
                    video.playsInline = true;
                    
                    videoPlayer.appendChild(video);
                    
                    // Setup HLS if needed
                    if (this.currentChannel.url.includes('.m3u8')) {
                        if (Hls.isSupported()) {
                            this.hls = new Hls({
                                debug: false,
                                enableWorker: false,
                                lowLatencyMode: true,
                                backBufferLength: 90
                            });
                            
                            this.hls.loadSource(this.currentChannel.url);
                            this.hls.attachMedia(video);
                            
                            this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                                console.log('Stream loaded successfully!');
                                // Update quality selector with available levels
                                this.updateQualitySelector();
                                // Apply saved quality setting
                                setTimeout(() => {
                                    this.applyQualityLevel(this.settings.quality);
                                }, 1000);
                            });
                            
                            this.hls.on(Hls.Events.ERROR, (event, data) => {
                                console.error('HLS Error:', data);
                            });
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = this.currentChannel.url;
                        }
                    } else {
                        video.src = this.currentChannel.url;
                    }
                    
                } catch (error) {
                    console.error('Playback error:', error);
                    videoPlaceholder.style.display = 'block';
                }
            }

            updatePlayerUI() {
                if (!this.currentChannel) return;

                document.getElementById('videoTitle').textContent = this.currentChannel.name;
                document.getElementById('videoCategory').textContent = this.currentChannel.group;
                document.getElementById('videoStatus').textContent = 'Live';
                document.getElementById('videoQuality').textContent = 'HD';
                
                const favoriteBtn = document.getElementById('favoriteBtn');
                const isFavorite = this.favorites.includes(this.currentChannel.id);
                
                favoriteBtn.classList.toggle('active', isFavorite);
                favoriteBtn.innerHTML = `
                    <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>
                    <span>${isFavorite ? 'Favorited' : 'Favorite'}</span>
                `;
            }

            // Search and Filter
            performSearch(query) {
                const searchInput = document.getElementById('searchInput');
                
                if (!query.trim()) {
                    this.filteredChannels = [...this.allChannels];
                } else {
                    this.filteredChannels = this.allChannels.filter(channel =>
                        channel.name.toLowerCase().includes(query.toLowerCase()) ||
                        channel.group.toLowerCase().includes(query.toLowerCase())
                    );
                }
                
                this.applyFilters();
                
                // Navigate to search if not already there and there's a query
                if (query.trim() && this.currentScreen !== 'search') {
                    this.navigateTo('search');
                }
            }

            applyFilters() {
                const categoryFilter = document.getElementById('categoryFilter').value;
                const languageFilter = document.getElementById('languageFilter').value;
                const qualityFilter = document.getElementById('qualityFilter').value;
                
                let filtered = [...this.allChannels]; // Apply filters to all channels (default + custom)
                
                const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
                if (searchQuery) {
                    filtered = filtered.filter(channel =>
                        channel.name.toLowerCase().includes(searchQuery) ||
                        channel.group.toLowerCase().includes(searchQuery)
                    );
                }

                if (categoryFilter) {
                    filtered = filtered.filter(ch => ch.group === categoryFilter);
                }
                
                if (languageFilter) {
                    filtered = filtered.filter(ch => this.extractLanguage(ch.name) === languageFilter);
                }
                
                if (qualityFilter) {
                    // Filter by quality (this would need to be enhanced based on actual channel data)
                    filtered = filtered.filter(ch => ch.name.toLowerCase().includes(qualityFilter.toLowerCase()));
                }
                
                this.filteredChannels = filtered;
                this.updateSearchResults();
            }

            resetFilters() {
                document.getElementById('categoryFilter').value = '';
                document.getElementById('languageFilter').value = '';
                document.getElementById('qualityFilter').value = '';
                document.getElementById('searchInput').value = '';
                document.getElementById('searchClear').classList.remove('show');
                
                this.filteredChannels = [...this.allChannels];
                this.updateSearchResults();
            }

            toggleFilterBar() {
                const filterBar = document.getElementById('filterBar');
                const filterToggle = document.getElementById('filterToggle');
                
                filterBar.classList.toggle('active');
                filterToggle.classList.toggle('active');
            }

            filterByCategory(category) {
                this.navigateTo('search');
                document.getElementById('categoryFilter').value = category;
                this.applyFilters();
            }

            // Favorites Management
            toggleFavorite() {
                if (!this.currentChannel) return;

                const channelId = this.currentChannel.id;
                const index = this.favorites.indexOf(channelId);
                
                if (index === -1) {
                    this.favorites.push(channelId);
                } else {
                    this.favorites.splice(index, 1);
                }
                
                this.saveToStorage('favorites', this.favorites);
                this.updatePlayerUI();
                this.updateUI();
            }

            addToRecent(channelId) {
                // Remove if already exists
                const index = this.recentChannels.indexOf(channelId);
                if (index !== -1) {
                    this.recentChannels.splice(index, 1);
                }
                
                // Add to beginning
                this.recentChannels.unshift(channelId);
                
                // Keep only last 10
                this.recentChannels = this.recentChannels.slice(0, 10);
                
                this.saveToStorage('recentChannels', this.recentChannels);
            }

            // Mini Player
            toggleMiniPlayer() {
                const miniPlayer = document.getElementById('miniPlayer');
                const miniPlayerBtn = document.getElementById('miniPlayerBtn');
                
                if (this.miniPlayerActive) {
                    this.closeMiniPlayer();
                } else {
                    this.activateMiniPlayer();
                }
            }

            activateMiniPlayer() {
                if (!this.currentChannel) {
                    return;
                }

                const miniPlayer = document.getElementById('miniPlayer');
                const miniPlayerTitle = document.getElementById('miniPlayerTitle');
                const miniPlayerVideo = document.getElementById('miniPlayerVideo');
                const videoPlayer = document.getElementById('videoPlayer');
                
                // Move video to mini player
                const video = videoPlayer.querySelector('video');
                if (video) {
                    miniPlayerVideo.appendChild(video.cloneNode());
                }
                
                miniPlayerTitle.textContent = this.currentChannel.name;
                miniPlayer.classList.add('active');
                this.miniPlayerActive = true;
                
                // Update button
                const miniPlayerBtn = document.getElementById('miniPlayerBtn');
                miniPlayerBtn.innerHTML = '<i class="fas fa-expand"></i><span>Expand</span>';
            }

            expandMiniPlayer() {
                this.navigateTo('player');
                this.closeMiniPlayer();
            }

            closeMiniPlayer() {
                const miniPlayer = document.getElementById('miniPlayer');
                const miniPlayerBtn = document.getElementById('miniPlayerBtn');
                
                miniPlayer.classList.remove('active');
                this.miniPlayerActive = false;
                
                // Clear mini player video
                document.getElementById('miniPlayerVideo').innerHTML = '';
                
                // Update button
                miniPlayerBtn.innerHTML = '<i class="fas fa-compress"></i><span>Mini Player</span>';
            }

            // EPG (Electronic Program Guide)
            showEPG() {
                if (!this.currentChannel) {
                    return;
                }

                const epgModal = document.getElementById('epgModal');
                const epgTitle = document.getElementById('epgTitle');
                const epgPrograms = document.getElementById('epgPrograms');
                
                epgTitle.textContent = `${this.currentChannel.name} - Program Guide`;
                
                // Generate sample EPG data (in real implementation, this would come from EPG API)
                const samplePrograms = this.generateSampleEPG();
                
                epgPrograms.innerHTML = samplePrograms.map(program => `
                    <div class="epg-program">
                        <div class="epg-time">${program.time}</div>
                        <div class="epg-program-title">${program.title}</div>
                        <div class="epg-program-desc">${program.description}</div>
                    </div>
                `).join('');
                
                epgModal.classList.add('active');
            }

            closeEPG() {
                document.getElementById('epgModal').classList.remove('active');
            }

            generateSampleEPG() {
                const now = new Date();
                const programs = [];
                
                for (let i = 0; i < 8; i++) {
                    const startTime = new Date(now.getTime() + (i * 60 * 60 * 1000));
                    const endTime = new Date(startTime.getTime() + (60 * 60 * 1000));
                    
                    programs.push({
                        time: `${this.formatTime(startTime)} - ${this.formatTime(endTime)}`,
                        title: `Program ${i + 1}`,
                        description: `Exciting content scheduled for this time slot. High-quality entertainment and information programming.`
                    });
                }
                
                return programs;
            }

            formatTime(date) {
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
            }

            // Theme and Settings
            toggleDarkMode() {
                this.settings.darkMode = !this.settings.darkMode;
                this.applyTheme();
                this.saveToStorage('settings', this.settings);
                this.updateSettingsScreen();
                
                const themeToggle = document.getElementById('themeToggle');
                themeToggle.innerHTML = `<i class="fas fa-${this.settings.darkMode ? 'sun' : 'moon'}"></i>`;
            }

            applyTheme() {
                document.body.setAttribute('data-theme', this.settings.darkMode ? 'dark' : 'light');
                
                // Update theme toggle icon
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.innerHTML = `<i class="fas fa-${this.settings.darkMode ? 'sun' : 'moon'}"></i>`;
                }
            }

            handleFullscreenChange() {
                const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                       document.mozFullScreenElement || document.msFullscreenElement);
                this.updateFullscreenButton(isFullscreen);
            }

            handleOrientationChange() {
                // Handle orientation changes for better mobile experience
                setTimeout(() => {
                    if (window.orientation !== undefined) {
                        const orientation = Math.abs(window.orientation) === 90 ? 'landscape' : 'portrait';
                        document.body.setAttribute('data-orientation', orientation);
                    }
                }, 500);
            }

            toggleAutoplay() {
                this.settings.autoplay = !this.settings.autoplay;
                this.saveToStorage('settings', this.settings);
                this.updateSettingsScreen();
            }

            // Quality Control
            toggleQualityDropdown() {
                const qualityDropdown = document.getElementById('qualityDropdown');
                const qualitySelector = document.getElementById('qualitySelector');
                
                qualityDropdown.classList.toggle('active');
                qualitySelector.classList.toggle('active');
                
                // Close dropdown when clicking outside
                if (qualityDropdown.classList.contains('active')) {
                    setTimeout(() => {
                        document.addEventListener('click', this.closeQualityDropdown.bind(this), { once: true });
                    }, 100);
                }
            }

            closeQualityDropdown(event) {
                const qualitySelector = document.getElementById('qualitySelector');
                if (!qualitySelector.contains(event.target)) {
                    document.getElementById('qualityDropdown').classList.remove('active');
                    qualitySelector.classList.remove('active');
                }
            }

            setQuality(quality) {
                try {
                    // Update UI
                    document.getElementById('currentQuality').textContent = quality === 'auto' ? 'Auto' : quality;
                    
                    // Update active state for all quality options
                    document.querySelectorAll('.quality-option').forEach(option => {
                        option.classList.remove('active');
                        const optionText = option.querySelector('span').textContent.toLowerCase();
                        if ((quality === 'auto' && optionText === 'auto') || 
                            (quality !== 'auto' && optionText === quality)) {
                            option.classList.add('active');
                        }
                    });
                    
                    // Close dropdown
                    document.getElementById('qualityDropdown').classList.remove('active');
                    document.getElementById('qualitySelector').classList.remove('active');
                    
                    // Save quality preference
                    this.settings.quality = quality;
                    this.saveToStorage('settings', this.settings);
                    
                    // Apply quality if video is playing and HLS is available
                    if (this.hls && this.currentChannel) {
                        this.applyQualityLevel(quality);
                    }
                    
                    console.log(`Quality set to ${quality === 'auto' ? 'Auto' : quality}`);
                    
                } catch (error) {
                    console.error('Failed to set quality:', error);
                }
            }

            applyQualityLevel(quality) {
                if (!this.hls || !this.hls.levels || this.hls.levels.length === 0) {
                    console.warn('HLS levels not available yet');
                    return;
                }
                
                try {
                    if (quality === 'auto') {
                        this.hls.currentLevel = -1; // Auto quality
                        console.log('Quality set to auto');
                    } else {
                        // Find the closest quality level
                        const levels = this.hls.levels;
                        let targetLevel = -1;
                        
                        const targetHeight = this.getTargetHeight(quality);
                        if (targetHeight > 0) {
                            targetLevel = this.findClosestLevel(levels, targetHeight);
                        }
                        
                        if (targetLevel !== -1 && targetLevel < levels.length) {
                            this.hls.currentLevel = targetLevel;
                            const actualHeight = levels[targetLevel].height;
                            console.log(`Quality set to ${quality} (actual: ${actualHeight}p)`);
                        } else {
                            console.warn(`Quality ${quality} not available, using auto`);
                            this.hls.currentLevel = -1;
                        }
                    }
                } catch (error) {
                    console.warn('Quality level change failed:', error);
                    // Fallback to auto quality
                    this.hls.currentLevel = -1;
                }
            }

            getTargetHeight(quality) {
                switch (quality) {
                    case '240p': return 240;
                    case '480p': return 480;
                    case '720p': return 720;
                    case '1080p': return 1080;
                    default: return 0;
                }
            }

            findClosestLevel(levels, targetHeight) {
                if (!levels || levels.length === 0) return -1;
                
                let closestLevel = 0;
                let smallestDiff = Math.abs(levels[0].height - targetHeight);
                
                for (let i = 1; i < levels.length; i++) {
                    const diff = Math.abs(levels[i].height - targetHeight);
                    if (diff < smallestDiff) {
                        smallestDiff = diff;
                        closestLevel = i;
                    }
                }
                
                return closestLevel;
            }

            updateQualitySelector() {
                if (!this.hls || !this.hls.levels || this.hls.levels.length === 0) {
                    return;
                }

                const qualityDropdown = document.getElementById('qualityDropdown');
                const availableLevels = this.hls.levels;
                
                // Clear existing options except Auto
                const autoOption = qualityDropdown.querySelector('.quality-option[onclick*="auto"]');
                qualityDropdown.innerHTML = '';
                if(autoOption) { // Ensure autoOption exists before appending
                    qualityDropdown.appendChild(autoOption);
                }

                // Add available quality levels
                const uniqueHeights = [...new Set(availableLevels.map(level => level.height))].sort((a, b) => b - a);
                
                uniqueHeights.forEach(height => {
                    const qualityText = `${height}p`;
                    const option = document.createElement('div');
                    option.className = 'quality-option';
                    option.onclick = () => this.setQuality(qualityText);
                    option.innerHTML = `
                        <span>${qualityText}</span>
                        <i class="fas fa-check"></i>
                    `;
                    qualityDropdown.appendChild(option);
                });

                console.log(`Quality selector updated with ${uniqueHeights.length} levels:`, uniqueHeights.map(h => `${h}p`));
            }

            toggleFullscreen() {
                const videoPlayer = document.getElementById('videoPlayer');
                const videoElement = document.getElementById('videoElement');
                
                try {
                    // Check if already in fullscreen
                    if (document.fullscreenElement || document.webkitFullscreenElement || 
                        document.mozFullScreenElement || document.msFullscreenElement) {
                        this.exitFullscreen();
                    } else {
                        this.enterFullscreen(videoPlayer);
                    }
                } catch (error) {
                    console.warn('Fullscreen operation failed:', error);
                }
            }

            enterFullscreen(element) {
                // Try different fullscreen APIs for cross-browser compatibility
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                } else {
                    console.warn('Fullscreen API not supported');
                    return;
                }

                // Handle mobile orientation for better fullscreen experience
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(() => {
                        // Orientation lock failed, continue anyway
                    });
                }

                // Update fullscreen button state
                this.updateFullscreenButton(true);
            }

            exitFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }

                // Unlock orientation when exiting fullscreen
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }

                // Update fullscreen button state
                this.updateFullscreenButton(false);
            }

            updateFullscreenButton(isFullscreen) {
                const fullscreenBtn = document.getElementById('fullscreenBtn');
                const icon = fullscreenBtn.querySelector('i');
                const text = fullscreenBtn.querySelector('span');
                
                if (isFullscreen) {
                    icon.className = 'fas fa-compress';
                    text.textContent = 'Exit Fullscreen';
                } else {
                    icon.className = 'fas fa-expand';
                    text.textContent = 'Fullscreen';
                }
            }

            shareChannel() {
                if (!this.currentChannel) {
                    return;
                }

                const shareData = {
                    title: this.currentChannel.name,
                    text: `Watch ${this.currentChannel.name} on LiveTV Mobile Pro`,
                    url: window.location.href
                };

                if (navigator.share) {
                    navigator.share(shareData);
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(shareData.url).then(() => {
                        console.log('Link copied to clipboard!');
                    }).catch(() => {
                        console.warn('Share not supported');
                    });
                }
            }

            // Settings Actions
            showQualitySettings() {
                console.log('Quality settings: Auto, HD, FHD, 4K available');
            }

            clearCache() {
                try {
                    // Clear localStorage
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('livetv_') || key.includes('cache') || key.includes('storage')) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => localStorage.removeItem(key));

                    // Clear sessionStorage
                    sessionStorage.clear();

                    // Clear browser cache for this origin (if supported)
                    if ('caches' in window) {
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => caches.delete(cacheName))
                            );
                        }).then(() => {
                            console.log('Service worker caches cleared');
                        }).catch(error => {
                            console.warn('Failed to clear service worker caches:', error);
                        });
                    }

                    // Clear HLS.js internal cache if available
                    if (this.hls) {
                        try {
                            // Destroy and recreate HLS instance to clear its cache
                            const currentTime = this.hls.media ? this.hls.media.currentTime : 0;
                            const currentSrc = this.hls.url;
                            
                            this.hls.destroy();
                            this.initializePlayer();
                            
                            // Restart current stream if one was playing
                            if (this.currentChannel && currentSrc) {
                                setTimeout(() => {
                                    this.playChannel(this.currentChannel);
                                }, 500);
                            }
                        } catch (error) {
                            console.warn('Failed to clear HLS cache:', error);
                        }
                    }

                    // Force reload of CSS and JS by appending timestamp (optional)
                    const timestamp = Date.now();
                    
                    console.log('Cache cleared successfully! Page will refresh to apply changes.');
                    
                    // Show user feedback
                    setTimeout(() => {
                        if (confirm('Cache cleared successfully! Refresh the page to complete the process?')) {
                            window.location.reload(true);
                        }
                    }, 500);

                } catch (error) {
                    console.error('Failed to clear cache completely:', error);
                    console.log('Partial cache clear completed');
                }
            }

            exportFavorites() {
                if (this.favorites.length === 0) {
                    return;
                }

                const favoriteChannels = this.allChannels.filter(ch => this.favorites.includes(ch.id));
                const exportData = {
                    exportDate: new Date().toISOString(),
                    version: '2.0',
                    favorites: favoriteChannels
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'livetv_favorites.json';
                a.click();
                URL.revokeObjectURL(url);

                console.log('Favorites exported successfully!');
            }

            showAbout() {
                console.log('LiveTV Mobile Pro v2.0 - Enhanced Mobile Experience by MiniMax Agent');
            }

            // Utility Functions
            generateId() {
                return 'ch_' + Math.random().toString(36).substr(2, 9);
            }

            getDefaultLogo() {
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiM2MzY2ZjEiLz4KPHN2ZyB4PSIxNSIgeT0iMTUiIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHA+PHBhdGggZD0iTTggNVYxOUwxOT0xIDhWNVoiIGZpbGw9IndoaXRlIi8+PC9wPgo8L3N2Zz4KPC9zdmc+';
            }

            getCategoryIcon(category) {
                const icons = {
                    'Entertainment': '<i class="fas fa-star"></i>',
                    'Movies': '<i class="fas fa-film"></i>',
                    'News': '<i class="fas fa-newspaper"></i>',
                    'Sports': '<i class="fas fa-football-ball"></i>',
                    'Kids': '<i class="fas fa-child"></i>',
                    'Music': '<i class="fas fa-music"></i>',
                    'Documentary': '<i class="fas fa-book"></i>',
                    'Lifestyle': '<i class="fas fa-heart"></i>'
                };
                
                return icons[category] || '<i class="fas fa-tv"></i>';
            }

            extractLanguage(channelName) {
                // Simple language detection based on channel name patterns
                if (channelName.match(/hindi|/i)) return 'Hindi';
                if (channelName.match(/english|eng/i)) return 'English';
                if (channelName.match(/tamil|/i)) return 'Tamil';
                if (channelName.match(/telugu|/i)) return 'Telugu';
                if (channelName.match(/malayalam|/i)) return 'Malayalam';
                if (channelName.match(/kannada|/i)) return 'Kannada';
                if (channelName.match(/bengali|/i)) return 'Bengali';
                if (channelName.match(/marathi|/i)) return 'Marathi';
                if (channelName.match(/punjabi|/i)) return 'Punjabi';
                if (channelName.match(/gujarati|/i)) return 'Gujarati';
                return null;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Keyboard Controls
            handleKeyboard(e) {
                switch (e.key) {
                    case 'f':
                    case 'F':
                        if (this.currentScreen === 'player') {
                            e.preventDefault();
                            this.toggleFullscreen();
                        }
                        break;
                    case 'Escape':
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                        } else if (document.getElementById('epgModal').classList.contains('active')) {
                            this.closeEPG();
                        }
                        break;
                    case '/':
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                        break;
                }
            }

            // Orientation Change
            handleOrientationChange() {
                // Adjust UI for orientation change
                if (window.innerHeight < window.innerWidth && this.currentScreen === 'player') {
                    // Landscape mode - hide navigation
                    document.querySelector('.bottom-nav').style.display = 'none';
                } else {
                    // Portrait mode - show navigation
                    document.querySelector('.bottom-nav').style.display = 'block';
                }
            }

            // Storage
            loadFromStorage(key, defaultValue) {
                try {
                    const item = localStorage.getItem(`livetv_mobile_${key}`);
                    return item ? JSON.parse(item) : defaultValue;
                } catch {
                    return defaultValue;
                }
            }

            saveToStorage(key, value) {
                try {
                    localStorage.setItem(`livetv_mobile_${key}`, JSON.stringify(value));
                } catch (error) {
                    console.warn('Failed to save to storage:', error);
                }
            }

            // UI Updates
            updateUI() {
                this.updateStats();
                if (this.currentScreen === 'home') {
                    this.updateHomeScreen();
                } else if (this.currentScreen === 'search') {
                    this.updateSearchScreen();
                } else if (this.currentScreen === 'favorites') {
                    this.updateFavoritesScreen();
                }
            }

            initializePlayer() {
                // Clean up existing HLS instance
                if (this.hls) {
                    this.hls.destroy();
                    this.hls = null;
                }

                // Reset video player
                const videoPlayer = document.getElementById('videoPlayer');
                const existingVideo = videoPlayer.querySelector('video');
                if (existingVideo) {
                    existingVideo.remove();
                }

                // Show placeholder
                const videoPlaceholder = document.getElementById('videoPlaceholder');
                if (videoPlaceholder) {
                    videoPlaceholder.style.display = 'block';
                }

                console.log('Player initialized and ready');
            }

            // Additional helper methods
            showAllRecent() {
                this.navigateTo('search');
                // Filter to show only recent channels
                this.filteredChannels = this.allChannels.filter(ch => this.recentChannels.includes(ch.id));
                this.updateSearchResults();
            }
        }

        // Initialize the app
        const app = new LiveTVMobileApp();

        // Service Worker for offline capabilities (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    // Silently fail if service worker not available
                });
            });
        }
    </script>
</body>
</html>
